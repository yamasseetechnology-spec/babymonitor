<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Yamassee Smart Monitor</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root{
  --gold:#FFD700;--gold-dim:#B8960C;--gold-glow:rgba(255,215,0,0.22);
  --red:#FF3B3B;--red-glow:rgba(255,59,59,0.35);
  --green:#39FF14;--green-glow:rgba(57,255,20,0.3);
  --bg:#070707;--s1:#0E0E0E;--s2:#151515;--s3:#1C1C1C;
  --border:rgba(255,215,0,0.13);
  --ui:'Rajdhani',sans-serif;--mono:'Share Tech Mono',monospace;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--gold);font-family:var(--ui);}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background:repeating-linear-gradient(to bottom,transparent 0,transparent 3px,rgba(0,0,0,0.05) 3px,rgba(0,0,0,0.05) 4px);}
#app{display:flex;flex-direction:column;height:100vh;height:100dvh;overflow:hidden;}

/* TOP BAR */
#top-bar{display:flex;justify-content:space-between;align-items:center;padding:9px 14px;
  background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;position:relative;}
#top-bar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--gold-dim),transparent);}
#logo{height:34px;filter:drop-shadow(0 0 8px var(--gold-glow));}
#status{display:flex;align-items:center;gap:6px;font-family:var(--mono);font-size:0.68rem;
  letter-spacing:0.1em;text-transform:uppercase;padding:4px 10px;background:var(--s2);
  border:1px solid var(--border);border-radius:20px;color:rgba(255,215,0,0.45);transition:all 0.3s;}
#status .dot{width:7px;height:7px;border-radius:50%;background:rgba(255,215,0,0.2);flex-shrink:0;transition:all 0.3s;}
#status.live{color:var(--gold);border-color:rgba(255,215,0,0.3);}
#status.live .dot{background:var(--green);box-shadow:0 0 8px var(--green-glow);animation:pulse 1.5s infinite;}
#status.watch{color:#7DF9FF;border-color:rgba(125,249,255,0.3);}
#status.watch .dot{background:#7DF9FF;box-shadow:0 0 8px rgba(125,249,255,0.4);animation:pulse 1.5s infinite;}
#status.busy{color:var(--gold);}
#status.busy .dot{background:var(--gold);animation:pulse 0.8s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.3;transform:scale(0.6)}}

/* TABS */
#tabs{display:flex;gap:6px;padding:7px 14px;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;}
.tab{flex:1;padding:7px 8px;font-family:var(--ui);font-size:0.82rem;font-weight:600;letter-spacing:0.07em;
  text-transform:uppercase;background:var(--s2);color:rgba(255,215,0,0.45);border:1px solid var(--border);
  border-radius:8px;cursor:pointer;transition:all 0.2s;min-height:44px;}
.tab.on{background:rgba(255,215,0,0.08);color:var(--gold);border-color:var(--gold-dim);box-shadow:0 0 14px rgba(255,215,0,0.1);}
.tab:hover:not(.on){background:var(--s3);color:var(--gold);}

/* SIGNAL PANEL */
#signal{display:none;flex-direction:column;gap:6px;padding:10px 14px;
  background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;}
#signal.show{display:flex;}
#sig-step{font-family:var(--mono);font-size:0.65rem;letter-spacing:0.08em;
  color:rgba(255,215,0,0.6);line-height:1.6;padding:4px 0;}
#signal textarea{background:var(--s2);color:var(--gold);border:1px solid var(--border);border-radius:8px;
  font-family:var(--mono);font-size:0.65rem;padding:8px 10px;resize:none;outline:none;
  height:68px;line-height:1.5;word-break:break-all;width:100%;}
#signal textarea:focus{border-color:var(--gold-dim);}
#signal textarea::placeholder{color:rgba(255,215,0,0.2);}
.srow{display:flex;gap:6px;}
.sbtn{padding:8px 14px;font-family:var(--ui);font-size:0.8rem;font-weight:700;letter-spacing:0.06em;
  text-transform:uppercase;background:rgba(255,215,0,0.1);color:var(--gold);
  border:1px solid rgba(255,215,0,0.4);border-radius:6px;cursor:pointer;transition:all 0.2s;white-space:nowrap;flex-shrink:0;}
.sbtn:hover{background:rgba(255,215,0,0.22);}
.sbtn.green{background:rgba(57,255,20,0.08);border-color:rgba(57,255,20,0.4);color:var(--green);}
.sbtn.green:hover{background:rgba(57,255,20,0.18);}

/* VIDEO AREA */
#cam-section{flex:1;min-height:0;display:flex;flex-direction:column;padding:10px 14px 6px;}
#cam-wrap{flex:1;min-height:0;position:relative;border-radius:20px;overflow:hidden;
  border:1px solid var(--border);background:var(--s1);box-shadow:inset 0 0 35px rgba(255,215,0,0.04),0 0 40px rgba(0,0,0,0.7);}
#cam-wrap::before,#cam-wrap::after{content:'';position:absolute;width:18px;height:18px;
  border-color:rgba(255,215,0,0.5);border-style:solid;z-index:6;pointer-events:none;}
#cam-wrap::before{top:10px;left:10px;border-width:2px 0 0 2px;border-radius:3px 0 0 0;}
#cam-wrap::after{bottom:10px;right:10px;border-width:0 2px 2px 0;border-radius:0 0 3px 0;}
#feed{width:100%;height:100%;object-fit:cover;display:block;border-radius:20px;background:#000;}
#mcanvas{display:none;position:absolute;inset:0;}

/* PLACEHOLDER */
#empty{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:14px;border-radius:20px;background:var(--s1);z-index:2;}
#empty svg{opacity:0.13;width:56px;height:56px;}
#empty p{font-family:var(--mono);font-size:0.7rem;letter-spacing:0.12em;text-transform:uppercase;
  color:rgba(255,215,0,0.28);text-align:center;padding:0 24px;line-height:1.9;}

/* LIVE BADGE */
#livebadge{position:absolute;bottom:14px;left:14px;display:none;align-items:center;gap:6px;
  background:rgba(0,0,0,0.75);backdrop-filter:blur(6px);border:1px solid rgba(255,59,59,0.5);
  border-radius:8px;padding:4px 10px;font-family:var(--mono);font-size:0.68rem;letter-spacing:0.14em;color:#fff;z-index:6;}
#livebadge .ldot{width:7px;height:7px;border-radius:50%;background:var(--red);box-shadow:0 0 7px var(--red-glow);animation:blink 1.2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.1}}

/* STATS */
#stats{position:absolute;bottom:14px;right:14px;display:flex;flex-direction:column;
  align-items:flex-end;gap:4px;z-index:6;pointer-events:none;}
.chip{background:rgba(0,0,0,0.72);backdrop-filter:blur(6px);border:1px solid var(--border);
  border-radius:6px;padding:3px 8px;font-family:var(--mono);font-size:0.62rem;letter-spacing:0.09em;color:rgba(255,215,0,0.5);}
.chip.hot{border-color:rgba(255,59,59,0.5);color:var(--red);background:rgba(255,59,59,0.12);}

/* ALERT FLASH */
#flash{position:absolute;inset:0;border-radius:20px;pointer-events:none;z-index:5;opacity:0;transition:opacity 0.1s;}
#flash.motion{background:radial-gradient(ellipse at center,rgba(255,215,0,0.1) 0%,transparent 70%);border:2px solid rgba(255,215,0,0.35);border-radius:20px;}
#flash.sound{background:radial-gradient(ellipse at center,rgba(255,59,59,0.1) 0%,transparent 70%);border:2px solid rgba(255,59,59,0.35);border-radius:20px;}

/* CONTROLS */
#ctrl{display:flex;flex-wrap:wrap;align-items:center;gap:8px;padding:8px 0 4px;flex-shrink:0;}
.btn{padding:0 16px;height:44px;font-family:var(--ui);font-size:0.88rem;font-weight:700;
  letter-spacing:0.08em;text-transform:uppercase;background:var(--s2);color:var(--gold);
  border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;white-space:nowrap;flex-shrink:0;}
.btn:hover{background:var(--s3);box-shadow:0 0 16px var(--gold-glow);border-color:rgba(255,215,0,0.35);}
.btn:active{transform:scale(0.97);}
.btn.primary{background:rgba(255,215,0,0.1);border-color:var(--gold-dim);box-shadow:0 0 14px var(--gold-glow);}
.btn.danger{border-color:rgba(255,59,59,0.4);color:var(--red);}
.btn:disabled{opacity:0.35;cursor:not-allowed;transform:none;}
#sensbox{display:flex;flex-direction:column;gap:3px;flex:1;min-width:110px;}
#senslbl{font-family:var(--mono);font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;
  color:rgba(255,215,0,0.45);display:flex;justify-content:space-between;}
#senslbl span{color:var(--gold);}
#sens{-webkit-appearance:none;appearance:none;width:100%;height:4px;border-radius:2px;
  background:linear-gradient(to right,var(--gold-dim) 50%,var(--s3) 50%);outline:none;cursor:pointer;}
#sens::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;
  background:var(--gold);border:2px solid var(--bg);box-shadow:0 0 8px var(--gold-glow);cursor:pointer;}
#alertbar{width:100%;padding:7px 12px;background:var(--s2);border:1px solid var(--border);
  border-radius:8px;font-family:var(--mono);font-size:0.72rem;letter-spacing:0.09em;
  color:rgba(255,215,0,0.45);display:flex;align-items:center;gap:8px;transition:all 0.3s;}
#alertbar .adot{width:7px;height:7px;border-radius:50%;background:rgba(255,215,0,0.25);flex-shrink:0;transition:all 0.3s;}
#alertbar.motion-alert{border-color:rgba(255,215,0,0.45);color:var(--gold);background:rgba(255,215,0,0.07);}
#alertbar.motion-alert .adot{background:var(--gold);box-shadow:0 0 8px var(--gold-glow);animation:pulse 0.8s infinite;}
#alertbar.sound-alert{border-color:rgba(255,59,59,0.5);color:var(--red);background:rgba(255,59,59,0.07);}
#alertbar.sound-alert .adot{background:var(--red);box-shadow:0 0 8px var(--red-glow);animation:pulse 0.8s infinite;}

/* TOASTS */
#toasts{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:1000;
  display:flex;flex-direction:column-reverse;gap:6px;pointer-events:none;width:calc(100% - 28px);max-width:420px;}
.toast{padding:10px 14px;border-radius:8px;font-family:var(--mono);font-size:0.75rem;
  letter-spacing:0.08em;background:rgba(14,14,14,0.97);border:1px solid var(--border);
  backdrop-filter:blur(10px);color:var(--gold);
  animation:tin 0.25s ease,tout 0.3s ease 2.7s forwards;box-shadow:0 4px 20px rgba(0,0,0,0.5);}
.toast.err{border-color:rgba(255,59,59,0.5);color:var(--red);}
.toast.ok{border-color:rgba(57,255,20,0.4);color:var(--green);}
@keyframes tin{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes tout{from{opacity:1}to{opacity:0;transform:translateY(-4px)}}
@media(min-width:600px){#ctrl{flex-wrap:nowrap;}#alertbar{width:auto;flex:1;}}
</style>
</head>
<body>
<div id="app">

  <div id="top-bar">
    <img id="logo" src="https://i.ibb.co/gFMKLNWd/Chat-GPT-Image-Dec-31-2025-01-45-02-AM-Photoroom.png" alt="Yamassee">
    <div id="status" class="off"><div class="dot"></div><span id="stxt">Offline</span></div>
  </div>

  <div id="tabs">
    <button class="tab on" id="tcam" onclick="setRole('camera')">üì∑ Room Camera</button>
    <button class="tab"    id="tview" onclick="setRole('viewer')">üëÅ Viewer</button>
  </div>

  <!-- SIGNAL PANEL ‚Äî shown during connection -->
  <div id="signal">
    <div id="sig-step">‚Äî</div>
    <label id="lout" style="font-family:var(--mono);font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,215,0,0.5);display:none;">Your Code (copy this):</label>
    <div class="srow">
      <textarea id="tout" readonly onclick="this.select()" style="display:none" placeholder="Code will appear here..."></textarea>
      <button class="sbtn" id="bcopy" onclick="doCopy()" style="display:none">üìã Copy</button>
    </div>
    <label id="lin" style="font-family:var(--mono);font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,215,0,0.5);display:none;">Paste Code Here:</label>
    <div class="srow" id="inrow" style="display:none">
      <textarea id="tin" onclick="this.select()" placeholder="Paste code here..."></textarea>
      <button class="sbtn green" onclick="doConnect()">Go ‚ñ∂</button>
    </div>
  </div>

  <div id="cam-section">
    <div id="cam-wrap">
      <video id="feed" autoplay playsinline></video>
      <canvas id="mcanvas"></canvas>
      <div id="empty">
        <svg viewBox="0 0 64 64" fill="none"><rect x="4" y="14" width="56" height="36" rx="6" stroke="#FFD700" stroke-width="2.5"/><circle cx="32" cy="32" r="9" stroke="#FFD700" stroke-width="2.5"/><rect x="22" y="10" width="20" height="6" rx="3" stroke="#FFD700" stroke-width="2"/><circle cx="52" cy="22" r="3" fill="#FFD700" opacity="0.6"/></svg>
        <p id="emsg">Tap Start Camera to begin</p>
      </div>
      <div id="livebadge"><div class="ldot"></div>LIVE</div>
      <div id="stats">
        <div class="chip" id="smot">MOTION: ‚Äî</div>
        <div class="chip" id="ssnd">SOUND: ‚Äî</div>
      </div>
      <div id="flash"></div>
    </div>
    <div id="ctrl">
      <button class="btn primary" id="bstart" onclick="startCam()">Start Camera</button>
      <button class="btn danger"  id="bstop"  onclick="stopAll()" disabled>Stop</button>
      <div id="sensbox">
        <div id="senslbl">Sensitivity <span id="sval">5</span></div>
        <input type="range" id="sens" min="1" max="10" value="5" oninput="setSens(this.value)">
      </div>
      <div id="alertbar"><div class="adot"></div><span id="alrt">No Alerts</span></div>
    </div>
  </div>
</div>
<div id="toasts"></div>

<script>
/* ================================================================
   YAMASSEE SMART MONITOR ‚Äî Clean build
   No servers. No accounts. No third parties.

   WebRTC manual signaling ‚Äî you copy a code from camera, paste
   into viewer, viewer sends a code back, paste into camera. Done.

   CAMERA ‚Üí copy Offer ‚Üí send to Viewer
   VIEWER  ‚Üí paste Offer ‚Üí copy Answer ‚Üí send to Camera  
   CAMERA  ‚Üí paste Answer ‚Üí CONNECTED ‚úì
================================================================ */

const ICE_CFG = { iceServers: [
  { urls: 'stun:stun.l.google.com:19302' },
  { urls: 'stun:stun1.l.google.com:19302' },
  { urls: 'stun:stun2.l.google.com:19302' },
  { urls: 'stun:stun3.l.google.com:19302' },
  { urls: 'turn:openrelay.metered.ca:80',              username:'openrelayproject', credential:'openrelayproject' },
  { urls: 'turn:openrelay.metered.ca:443',             username:'openrelayproject', credential:'openrelayproject' },
  { urls: 'turn:openrelay.metered.ca:443?transport=tcp', username:'openrelayproject', credential:'openrelayproject' }
]};

// ‚îÄ‚îÄ DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const G = id => document.getElementById(id);
const feed    = G('feed');
const mcanvas = G('mcanvas');
const empty   = G('empty');
const emsg    = G('emsg');
const livebdg = G('livebadge');
const flash   = G('flash');
const stxt    = G('stxt');
const status  = G('status');
const smot    = G('smot');
const ssnd    = G('ssnd');
const alrt    = G('alrt');
const alertbar= G('alertbar');
const bstart  = G('bstart');
const bstop   = G('bstop');
const signal  = G('signal');
const sigstep = G('sig-step');
const tout    = G('tout');
const tin     = G('tin');
const lout    = G('lout');
const lin     = G('lin');
const inrow   = G('inrow');
const bcopy   = G('bcopy');

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let ROLE     = 'camera';
let pc       = null;
let stream   = null;
let sens     = 5;
let mctx     = null;
let prev     = null;
let floop    = null;
let actx     = null;
let analyser = null;
let tLM      = 0;
let tLS      = 0;

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, cls='') {
  const d = document.createElement('div');
  d.className = 'toast ' + cls;
  d.textContent = msg;
  G('toasts').prepend(d);
  setTimeout(() => d.remove(), 3200);
}
function setStat(cls, txt) { status.className = cls; stxt.textContent = txt; }
function showEmpty(msg)    { emsg.textContent = msg; empty.style.display = ''; }
function hideEmpty()       { empty.style.display = 'none'; }
function setAlert(type, msg) {
  alertbar.className = type === 'clear' ? '' : type + '-alert';
  alrt.textContent = msg;
  if (type !== 'clear') {
    flash.className = type; flash.style.opacity = '1';
    setTimeout(() => { flash.style.opacity = '0'; flash.className = ''; }, 700);
    setTimeout(() => setAlert('clear', 'No Alerts'), 4000);
  }
}
function setSens(v) {
  sens = parseInt(v); G('sval').textContent = v;
  G('sens').style.background = `linear-gradient(to right,var(--gold-dim) 0%,var(--gold-dim) ${v*10}%,var(--s3) ${v*10}%,var(--s3) 100%)`;
}
setSens(5);

// ‚îÄ‚îÄ ENCODE / DECODE ‚Äî safe base64 that survives copy-paste ‚îÄ‚îÄ‚îÄ‚îÄ
function enc(obj) {
  // Pull out only what we need ‚Äî avoids non-enumerable property issues
  const data = { type: obj.type, sdp: obj.sdp };
  const str  = JSON.stringify(data);
  // Convert to base64 safely (handles unicode)
  return btoa(String.fromCharCode(...new TextEncoder().encode(str)));
}
function dec(raw) {
  // Strip ALL whitespace ‚Äî handles accidental newlines from copy-paste
  const clean = raw.replace(/\s/g, '');
  // Decode base64 back to string
  const str   = new TextDecoder().decode(Uint8Array.from(atob(clean), c => c.charCodeAt(0)));
  const obj   = JSON.parse(str);
  if (!obj.type || !obj.sdp) throw new Error('Bad code');
  return obj;
}

// ‚îÄ‚îÄ COPY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doCopy() {
  const val = tout.value;
  if (!val) return;
  navigator.clipboard.writeText(val)
    .then(() => {
      toast('‚úì Code copied!', 'ok');
      bcopy.textContent = '‚úì Done';
      setTimeout(() => bcopy.textContent = 'üìã Copy', 2000);
    })
    .catch(() => {
      // Fallback for browsers that block clipboard
      tout.select();
      document.execCommand('copy');
      toast('‚úì Code copied!', 'ok');
    });
}

// ‚îÄ‚îÄ SIGNAL UI HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sigShow(step, outCode, showIn) {
  signal.classList.add('show');
  sigstep.textContent = step;
  if (outCode) {
    lout.style.display = 'block';
    tout.style.display = 'block';
    tout.value = outCode;
    bcopy.style.display = 'block';
  } else {
    lout.style.display = 'none';
    tout.style.display = 'none';
    bcopy.style.display = 'none';
  }
  if (showIn) {
    lin.style.display = 'block';
    inrow.style.display = 'flex';
    tin.value = '';
  } else {
    lin.style.display = 'none';
    inrow.style.display = 'none';
  }
}
function sigHide() { signal.classList.remove('show'); }

// ‚îÄ‚îÄ ROLE SWITCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setRole(r) {
  ROLE = r;
  G('tcam').classList.toggle('on',  r === 'camera');
  G('tview').classList.toggle('on', r === 'viewer');
  bstart.style.display  = r === 'camera' ? '' : 'none';
  bstop.style.display   = r === 'camera' ? '' : 'none';
  G('sensbox').style.display = r === 'camera' ? '' : 'none';
  stopAll();
  if (r === 'viewer') {
    sigShow('Step 1 ‚Äî Paste the Offer code from the Camera, then tap Go ‚ñ∂', null, true);
    showEmpty('Paste the camera code above then tap Go');
  } else {
    sigHide();
    showEmpty('Tap Start Camera to begin');
  }
}

// ‚îÄ‚îÄ WAIT FOR ICE GATHERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function waitForICE(pc) {
  return new Promise(resolve => {
    if (pc.iceGatheringState === 'complete') return resolve();
    const check = () => { if (pc.iceGatheringState === 'complete') { pc.removeEventListener('icegatheringstatechange', check); resolve(); } };
    pc.addEventListener('icegatheringstatechange', check);
    // Safety timeout ‚Äî send whatever we have after 6s
    setTimeout(resolve, 6000);
  });
}

// ‚îÄ‚îÄ START CAMERA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startCam() {
  bstart.disabled = true;
  setStat('busy', 'Starting...');
  showEmpty('Requesting camera access...');

  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  } catch(e1) {
    try { stream = await navigator.mediaDevices.getUserMedia({ video: true }); }
    catch(e2) {
      bstart.disabled = false;
      setStat('off', 'Offline');
      showEmpty('Camera access denied\nCheck browser permissions');
      toast('Camera denied', 'err');
      return;
    }
  }

  // Show local feed immediately
  feed.muted   = true;
  feed.srcObject = stream;
  hideEmpty();
  livebdg.style.display = 'flex';
  bstop.disabled  = false;
  bstart.disabled = false;
  bstart.textContent = 'Restart';
  setStat('busy', 'Waiting for viewer...');

  // Create peer connection
  pc = new RTCPeerConnection(ICE_CFG);
  stream.getTracks().forEach(t => pc.addTrack(t, stream));

  pc.onconnectionstatechange = () => {
    if (pc.connectionState === 'connected') {
      setStat('live', 'Broadcasting');
      sigHide();
      toast('‚úì Viewer connected ‚Äî live!', 'ok');
    }
    if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
      setStat('live', 'Viewer left');
      toast('Viewer disconnected', '');
    }
  };

  // Create offer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await waitForICE(pc);

  // Show offer code
  sigShow(
    'üìã Step 1: Copy this code ‚Üí send to Viewer device\n‚è≥ Step 2: Paste their Answer code below when you get it back',
    enc(pc.localDescription),
    true
  );
  toast('Copy the Offer code and send it to the Viewer', '');
}

// ‚îÄ‚îÄ VIEWER: paste offer ‚Üí connect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doConnect() {
  const raw = tin.value.trim();
  if (!raw) { toast('Paste a code first', 'err'); return; }

  let data;
  try { data = dec(raw); }
  catch(e) { toast('Invalid code ‚Äî copy it again carefully', 'err'); return; }

  // ‚îÄ‚îÄ CAMERA side: receiving viewer's Answer ‚îÄ‚îÄ
  if (ROLE === 'camera') {
    if (!pc) { toast('Start camera first', 'err'); return; }
    if (data.type !== 'answer') { toast('This looks like an Offer ‚Äî camera needs an Answer code', 'err'); return; }
    try {
      await pc.setRemoteDescription(new RTCSessionDescription(data));
      toast('Answer accepted ‚Äî connecting...', 'ok');
      tin.value = '';
    } catch(e) {
      toast('Failed: ' + e.message, 'err');
    }
    return;
  }

  // ‚îÄ‚îÄ VIEWER side: receiving camera's Offer ‚îÄ‚îÄ
  if (ROLE === 'viewer') {
    if (data.type !== 'offer') { toast('This looks like an Answer ‚Äî viewer needs the Offer code from camera', 'err'); return; }
    if (pc) { pc.close(); pc = null; }
    stopDetect();

    pc = new RTCPeerConnection(ICE_CFG);

    pc.ontrack = e => {
      // ontrack fires for each track ‚Äî grab the stream on any call
      const s = e.streams && e.streams[0] ? e.streams[0] : (feed.srcObject || new MediaStream([e.track]));
      if (!feed.srcObject || !feed.srcObject.getVideoTracks().length) {
        feed.muted = false;
        feed.srcObject = s;
        feed.play().catch(() => {});
      }
      if (e.track.kind === 'video') {
        hideEmpty();
        livebdg.style.display = 'flex';
        setStat('watch', 'Watching');
        toast('‚úì Live feed connected!', 'ok');
        startDetect(s);
      }
    };

    pc.onconnectionstatechange = () => {
      if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
        showEmpty('Camera disconnected');
        feed.srcObject = null;
        livebdg.style.display = 'none';
        setStat('off', 'Disconnected');
        stopDetect();
        toast('Camera feed ended', 'err');
      }
    };

    await pc.setRemoteDescription(new RTCSessionDescription(data));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await waitForICE(pc);

    // Show answer code for viewer to send back to camera
    sigShow(
      'üìã Copy this Answer code ‚Üí send back to Camera device\nThen paste it into the camera and tap Go ‚ñ∂',
      enc(pc.localDescription),
      false
    );
    // Only show placeholder if video not already playing
    if (!feed.srcObject) {
      showEmpty('Send the Answer code to the Camera device\nVideo will appear here once connected');
    }
    setStat('busy', 'Waiting for camera...');
    toast('Copy the Answer code and send it back to camera', '');
  }
}

// ‚îÄ‚îÄ STOP ALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function stopAll() {
  stopDetect();
  if (pc)     { pc.close(); pc = null; }
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  feed.srcObject = null;
  feed.muted = true;
  livebdg.style.display = 'none';
  bstart.disabled = false;
  bstart.textContent = 'Start Camera';
  bstop.disabled = true;
  setStat('off', 'Offline');
  setAlert('clear', 'No Alerts');
  smot.textContent = 'MOTION: ‚Äî';
  ssnd.textContent = 'SOUND: ‚Äî';
  smot.classList.remove('hot');
  ssnd.classList.remove('hot');
  sigHide();
  tout.value = '';
  tin.value = '';
}

// ‚îÄ‚îÄ DETECTION (VIEWER SIDE ONLY) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startDetect(s) {
  stopDetect();
  mcanvas.width  = 160;
  mcanvas.height = 120;
  mctx = mcanvas.getContext('2d', { willReadFrequently: true });
  prev = null;
  motionLoop();

  try {
    const track = s.getAudioTracks()[0];
    if (track) {
      actx     = new (window.AudioContext || window.webkitAudioContext)();
      const src = actx.createMediaStreamSource(new MediaStream([track]));
      analyser  = actx.createAnalyser();
      analyser.fftSize = 512;
      src.connect(analyser);
      soundLoop();
    }
  } catch(e) { console.warn('Audio detect unavailable'); }
}

function stopDetect() {
  if (floop)   { cancelAnimationFrame(floop); floop = null; }
  if (actx)    { try { actx.close(); } catch(e){} actx = null; analyser = null; }
  prev = null;
}

function motionLoop() {
  if (!feed.srcObject) { floop = requestAnimationFrame(() => setTimeout(motionLoop, 300)); return; }
  floop = requestAnimationFrame(() => setTimeout(motionLoop, 120));
  if (feed.readyState < 2) return;
  try { mctx.drawImage(feed, 0, 0, 160, 120); } catch(e) { return; }
  const cur = mctx.getImageData(0, 0, 160, 120);
  if (prev) {
    const d1 = prev.data, d2 = cur.data;
    let n = 0;
    const thr = 28 * (1 - (sens - 1) / 12);
    for (let i = 0; i < d1.length; i += 4)
      if ((Math.abs(d1[i]-d2[i]) + Math.abs(d1[i+1]-d2[i+1]) + Math.abs(d1[i+2]-d2[i+2])) / 3 > thr) n++;
    const ratio = n / (d1.length / 4);
    const lvl   = Math.min(100, Math.round(ratio * 4500));
    smot.textContent = 'MOTION: ' + lvl + '%';
    smot.classList.toggle('hot', lvl > 25);
    const now = Date.now();
    if (ratio > 0.012 * (1 - (sens-1)/14) && now - tLM > 2500) {
      tLM = now; fireAlert('motion', '‚ö° Motion Detected');
    }
  }
  prev = cur;
}

function soundLoop() {
  if (!actx) return;
  requestAnimationFrame(soundLoop);
  const data = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(data);
  let sum = 0;
  for (let i = 0; i < data.length; i++) sum += data[i];
  const avg = sum / data.length / 255;
  const lvl = Math.min(100, Math.round(avg * 500));
  ssnd.textContent = 'SOUND: ' + lvl + '%';
  ssnd.classList.toggle('hot', lvl > 30);
  const now = Date.now();
  if (avg > 0.10 * (1 - (sens-1)/13) && now - tLS > 2000) {
    tLS = now; fireAlert('sound', 'üîä Sound Detected');
  }
}

function fireAlert(type, msg) {
  setAlert(type, msg);
  toast('üîî ' + msg, type === 'sound' ? 'err' : '');
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setRole('camera');
</script>
</body>
</html>
