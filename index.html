<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Yamassee Smart Monitor</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --gold:#FFD700; --gold-dim:#B8960C; --gold-glow:rgba(255,215,0,0.22);
  --red:#FF3B3B; --red-glow:rgba(255,59,59,0.35);
  --green:#39FF14; --green-glow:rgba(57,255,20,0.3);
  --bg:#070707; --s1:#0E0E0E; --s2:#151515; --s3:#1C1C1C;
  --border:rgba(255,215,0,0.13);
  --font-ui:'Rajdhani',sans-serif; --font-mono:'Share Tech Mono',monospace;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--gold);font-family:var(--font-ui);}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;background:repeating-linear-gradient(to bottom,transparent 0px,transparent 3px,rgba(0,0,0,0.05) 3px,rgba(0,0,0,0.05) 4px);}
#app{display:flex;flex-direction:column;height:100vh;height:100dvh;overflow:hidden;}

/* TOP BAR */
#top-bar{display:flex;justify-content:space-between;align-items:center;padding:9px 14px;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;position:relative;}
#top-bar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold-dim),transparent);}
#logo{height:34px;width:auto;filter:drop-shadow(0 0 8px var(--gold-glow));}
#conn-status{display:flex;align-items:center;gap:6px;font-family:var(--font-mono);font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;padding:4px 10px;background:var(--s2);border:1px solid var(--border);border-radius:20px;color:rgba(255,215,0,0.45);transition:all 0.3s;}
#conn-status .dot{width:7px;height:7px;border-radius:50%;background:rgba(255,215,0,0.25);flex-shrink:0;transition:all 0.3s;}
#conn-status.live .dot{background:var(--green);box-shadow:0 0 8px var(--green-glow);animation:pdot 1.5s infinite;}
#conn-status.live{color:var(--gold);border-color:rgba(255,215,0,0.3);}
#conn-status.connecting .dot{background:var(--gold);animation:pdot 0.9s infinite;}
#conn-status.viewer-live .dot{background:#7DF9FF;box-shadow:0 0 8px rgba(125,249,255,0.4);animation:pdot 1.5s infinite;}
#conn-status.viewer-live{color:#7DF9FF;border-color:rgba(125,249,255,0.3);}
@keyframes pdot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.3;transform:scale(0.65)}}

/* TABS */
#role-tabs{display:flex;gap:6px;padding:7px 14px;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;}
.rtab{flex:1;padding:7px 8px;font-family:var(--font-ui);font-size:0.82rem;font-weight:600;letter-spacing:0.07em;text-transform:uppercase;background:var(--s2);color:rgba(255,215,0,0.45);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;min-height:44px;}
.rtab.active{background:rgba(255,215,0,0.08);color:var(--gold);border-color:var(--gold-dim);box-shadow:0 0 14px rgba(255,215,0,0.1);}
.rtab:hover:not(.active){background:var(--s3);color:var(--gold);}

/* VIEWER PANEL */
#viewer-panel{display:none;flex-direction:column;gap:8px;padding:10px 14px;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;}
#viewer-panel.show{display:flex;}
#viewer-panel label{font-family:var(--font-mono);font-size:0.68rem;letter-spacing:0.12em;text-transform:uppercase;color:rgba(255,215,0,0.5);}
#active-rooms-list{display:flex;flex-direction:column;gap:6px;}
.room-card{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--s2);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;}
.room-card:hover{background:var(--s3);border-color:rgba(255,215,0,0.35);box-shadow:0 0 12px rgba(255,215,0,0.1);}
.room-card .rc-id{font-family:var(--font-mono);font-size:0.9rem;letter-spacing:0.15em;color:var(--gold);}
.room-card .rc-status{font-family:var(--font-mono);font-size:0.62rem;letter-spacing:0.1em;color:var(--green);display:flex;align-items:center;gap:5px;}
.room-card .rc-status::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green-glow);}
.room-card .rc-watch{padding:5px 12px;font-family:var(--font-ui);font-size:0.78rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;background:rgba(255,215,0,0.1);color:var(--gold);border:1px solid rgba(255,215,0,0.4);border-radius:6px;cursor:pointer;transition:all 0.2s;}
.room-card .rc-watch:hover{background:rgba(255,215,0,0.2);}
#no-rooms{font-family:var(--font-mono);font-size:0.72rem;letter-spacing:0.1em;color:rgba(255,215,0,0.3);text-align:center;padding:10px;}
#refresh-rooms{padding:6px 14px;font-family:var(--font-ui);font-size:0.78rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;background:var(--s2);color:rgba(255,215,0,0.6);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all 0.2s;align-self:flex-end;}
#refresh-rooms:hover{color:var(--gold);border-color:rgba(255,215,0,0.35);}

/* CAMERA SECTION */
#cam-section{flex:1;min-height:0;display:flex;flex-direction:column;padding:10px 14px 6px;}
#cam-wrapper{flex:1;min-height:0;position:relative;border-radius:20px;overflow:hidden;border:1px solid var(--border);background:var(--s1);box-shadow:inset 0 0 35px rgba(255,215,0,0.05),0 0 40px rgba(0,0,0,0.7);}
#cam-wrapper::before,#cam-wrapper::after{content:'';position:absolute;width:18px;height:18px;border-color:rgba(255,215,0,0.5);border-style:solid;z-index:6;pointer-events:none;}
#cam-wrapper::before{top:10px;left:10px;border-width:2px 0 0 2px;border-radius:3px 0 0 0;}
#cam-wrapper::after{bottom:10px;right:10px;border-width:0 2px 2px 0;border-radius:0 0 3px 0;}
#camera-feed{width:100%;height:100%;object-fit:cover;display:block;border-radius:20px;}
#motion-canvas{display:none;position:absolute;inset:0;}

/* PLACEHOLDER */
#cam-placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;}
#cam-placeholder svg{opacity:0.15;width:56px;height:56px;}
#cam-placeholder p{font-family:var(--font-mono);font-size:0.72rem;letter-spacing:0.16em;text-transform:uppercase;color:rgba(255,215,0,0.3);}

/* ROOM ID OVERLAY â€” on the video, center top */
#room-id-overlay{
  position:absolute;top:16px;left:50%;transform:translateX(-50%);
  z-index:20;display:none;
  font-family:'Share Tech Mono',monospace;font-size:1.15rem;font-weight:700;
  letter-spacing:0.25em;text-transform:uppercase;color:#FFD700;
  background:rgba(0,0,0,0.78);backdrop-filter:blur(10px);
  padding:7px 22px;border-radius:30px;
  border:1.5px solid rgba(255,215,0,0.55);
  box-shadow:0 0 22px rgba(255,215,0,0.28),inset 0 0 10px rgba(255,215,0,0.05);
  text-shadow:0 0 14px rgba(255,215,0,0.8);
  white-space:nowrap;pointer-events:none;
}

/* LIVE badge */
#live-badge{position:absolute;bottom:14px;left:14px;display:none;align-items:center;gap:6px;background:rgba(0,0,0,0.72);backdrop-filter:blur(6px);border:1px solid rgba(255,59,59,0.45);border-radius:8px;padding:4px 10px;font-family:var(--font-mono);font-size:0.68rem;letter-spacing:0.14em;color:#fff;z-index:6;}
#live-badge .ldot{width:7px;height:7px;border-radius:50%;background:var(--red);box-shadow:0 0 7px var(--red-glow);animation:blink 1.2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.15}}

/* Stats */
#cam-stats{position:absolute;bottom:14px;right:14px;display:flex;flex-direction:column;align-items:flex-end;gap:4px;z-index:6;pointer-events:none;}
.stat-chip{display:flex;align-items:center;gap:5px;background:rgba(0,0,0,0.68);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-family:var(--font-mono);font-size:0.62rem;letter-spacing:0.09em;color:rgba(255,215,0,0.5);}
.stat-chip.hot{border-color:rgba(255,59,59,0.5);color:var(--red);background:rgba(255,59,59,0.1);}

/* Alert flash */
#alert-flash{position:absolute;inset:0;border-radius:20px;pointer-events:none;z-index:5;opacity:0;transition:opacity 0.1s;}
#alert-flash.motion{background:radial-gradient(ellipse at center,rgba(255,215,0,0.07) 0%,transparent 70%);border:2px solid rgba(255,215,0,0.28);border-radius:20px;}
#alert-flash.sound{background:radial-gradient(ellipse at center,rgba(255,59,59,0.08) 0%,transparent 70%);border:2px solid rgba(255,59,59,0.3);border-radius:20px;}

/* CONTROLS */
#ctrl-bar{display:flex;flex-wrap:wrap;align-items:center;gap:8px;padding:8px 0 4px;flex-shrink:0;}
.ctrl-btn{padding:0 16px;height:44px;font-family:var(--font-ui);font-size:0.88rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;background:var(--s2);color:var(--gold);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;box-shadow:0 0 10px rgba(255,215,0,0.08);white-space:nowrap;flex-shrink:0;}
.ctrl-btn:hover{background:var(--s3);box-shadow:0 0 18px var(--gold-glow);border-color:rgba(255,215,0,0.35);}
.ctrl-btn:active{transform:scale(0.97);}
.ctrl-btn.primary{background:rgba(255,215,0,0.1);border-color:var(--gold-dim);box-shadow:0 0 16px var(--gold-glow);}
.ctrl-btn.danger{border-color:rgba(255,59,59,0.4);color:var(--red);}
.ctrl-btn:disabled{opacity:0.35;cursor:not-allowed;transform:none;}
#sens-group{display:flex;flex-direction:column;gap:3px;flex:1;min-width:110px;}
#sens-label{font-family:var(--font-mono);font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;color:rgba(255,215,0,0.45);display:flex;justify-content:space-between;}
#sens-label span{color:var(--gold);}
#sensitivity{-webkit-appearance:none;appearance:none;width:100%;height:4px;border-radius:2px;background:linear-gradient(to right,var(--gold-dim) 50%,var(--s3) 50%);outline:none;cursor:pointer;}
#sensitivity::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--gold);border:2px solid var(--bg);box-shadow:0 0 8px var(--gold-glow);cursor:pointer;}
#sensitivity::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--gold);border:2px solid var(--bg);cursor:pointer;}
#alert-bar{width:100%;padding:7px 12px;background:var(--s2);border:1px solid var(--border);border-radius:8px;font-family:var(--font-mono);font-size:0.72rem;letter-spacing:0.09em;color:rgba(255,215,0,0.45);display:flex;align-items:center;gap:8px;transition:all 0.3s;}
#alert-bar .ab-dot{width:7px;height:7px;border-radius:50%;background:rgba(255,215,0,0.25);flex-shrink:0;transition:all 0.3s;}
#alert-bar.motion-alert{border-color:rgba(255,215,0,0.45);color:var(--gold);background:rgba(255,215,0,0.07);}
#alert-bar.motion-alert .ab-dot{background:var(--gold);box-shadow:0 0 8px var(--gold-glow);animation:pdot 0.8s infinite;}
#alert-bar.sound-alert{border-color:rgba(255,59,59,0.5);color:var(--red);background:rgba(255,59,59,0.07);}
#alert-bar.sound-alert .ab-dot{background:var(--red);box-shadow:0 0 8px var(--red-glow);animation:pdot 0.8s infinite;}

/* TOASTS */
#toast-stack{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:1000;display:flex;flex-direction:column-reverse;gap:6px;pointer-events:none;width:calc(100% - 28px);max-width:420px;}
.toast{padding:10px 14px;border-radius:8px;font-family:var(--font-mono);font-size:0.75rem;letter-spacing:0.08em;background:rgba(14,14,14,0.95);border:1px solid var(--border);backdrop-filter:blur(10px);color:var(--gold);animation:toastin 0.25s ease,toastout 0.3s ease 2.7s forwards;box-shadow:0 4px 20px rgba(0,0,0,0.5);}
.toast.error{border-color:rgba(255,59,59,0.5);color:var(--red);}
.toast.success{border-color:rgba(57,255,20,0.4);color:var(--green);}
@keyframes toastin{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes toastout{from{opacity:1}to{opacity:0}}
@media(min-width:600px){#ctrl-bar{flex-wrap:nowrap;}#alert-bar{width:auto;flex:1;}}
</style>
</head>
<body>
<div id="app">

  <!-- TOP BAR -->
  <div id="top-bar">
    <img id="logo" src="https://i.ibb.co/gFMKLNWd/Chat-GPT-Image-Dec-31-2025-01-45-02-AM-Photoroom.png" alt="Yamassee">
    <div id="conn-status" class="offline">
      <div class="dot"></div>
      <span id="conn-text">Offline</span>
    </div>
  </div>

  <!-- TABS -->
  <div id="role-tabs">
    <button class="rtab active" id="tab-camera" onclick="switchRole('camera')">ğŸ“· Room Camera</button>
    <button class="rtab" id="tab-viewer" onclick="switchRole('viewer')">ğŸ‘ Viewer</button>
  </div>

  <!-- VIEWER PANEL â€” shows active cameras to select -->
  <div id="viewer-panel">
    <label>Active Cameras â€” tap one to watch</label>
    <div id="active-rooms-list">
      <div id="no-rooms">No active cameras found</div>
    </div>
    <button id="refresh-rooms" onclick="refreshRooms()">â†» Refresh</button>
  </div>

  <!-- CAMERA SECTION -->
  <div id="cam-section">
    <div id="cam-wrapper">

      <video id="camera-feed" autoplay muted playsinline></video>
      <canvas id="motion-canvas"></canvas>

      <!-- PLACEHOLDER -->
      <div id="cam-placeholder">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="4" y="14" width="56" height="36" rx="6" stroke="#FFD700" stroke-width="2.5"/>
          <circle cx="32" cy="32" r="9" stroke="#FFD700" stroke-width="2.5"/>
          <rect x="22" y="10" width="20" height="6" rx="3" stroke="#FFD700" stroke-width="2"/>
          <circle cx="52" cy="22" r="3" fill="#FFD700" opacity="0.6"/>
        </svg>
        <p id="placeholder-msg">Tap Start Camera to begin</p>
      </div>

      <!-- ROOM ID ON VIDEO â€” shows when camera is live -->
      <div id="room-id-overlay"></div>

      <!-- LIVE -->
      <div id="live-badge"><div class="ldot"></div>LIVE</div>

      <!-- Stats -->
      <div id="cam-stats">
        <div class="stat-chip" id="stat-motion">MOTION: â€”</div>
        <div class="stat-chip" id="stat-sound">SOUND: â€”</div>
      </div>

      <!-- Alert flash -->
      <div id="alert-flash"></div>
    </div>

    <!-- CONTROLS -->
    <div id="ctrl-bar">
      <button class="ctrl-btn primary" id="start-btn" onclick="startCamera()">Start Camera</button>
      <button class="ctrl-btn danger" id="stop-btn" onclick="stopCamera()" disabled>Stop</button>
      <div id="sens-group">
        <div id="sens-label">Sensitivity <span id="sens-val">5</span></div>
        <input type="range" id="sensitivity" min="1" max="10" value="5" oninput="updateSensitivity(this.value)">
      </div>
      <div id="alert-bar">
        <div class="ab-dot"></div>
        <span id="alert-text">No Alerts</span>
      </div>
    </div>
  </div>
</div>

<div id="toast-stack"></div>

<script>
/* ============================================================
   YAMASSEE SMART MONITOR
   - Camera starts immediately, Room ID shown on video
   - Viewer sees list of active cameras, taps to connect
============================================================ */

const CONFIG = {
  WS_URL: (location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.hostname + ':3000',
  ICE_SERVERS: [{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}],
  MOTION_THRESHOLD: 30,
  MOTION_PIXEL_PCT: 0.015,
  MOTION_COOLDOWN: 2500,
  SOUND_THRESHOLD: 0.12,
  SOUND_COOLDOWN: 2000,
  FRAME_MS: 150,
};

const STATE = {
  role: 'camera',
  roomId: null,
  ws: null,
  wsReady: false,
  localStream: null,
  peerConnections: {},
  sensitivity: 5,
  motionCtx: null,
  prevFrame: null,
  frameLoop: null,
  audioCtx: null,
  analyser: null,
  lastMotion: 0,
  lastSound: 0,
  viewerPc: null,
  activeRooms: [],
};

const $ = id => document.getElementById(id);
const video         = $('camera-feed');
const canvas        = $('motion-canvas');
const placeholder   = $('cam-placeholder');
const liveBadge     = $('live-badge');
const alertBar      = $('alert-bar');
const alertText     = $('alert-text');
const alertFlash    = $('alert-flash');
const connStatus    = $('conn-status');
const connText      = $('conn-text');
const statMotion    = $('stat-motion');
const statSound     = $('stat-sound');
const startBtn      = $('start-btn');
const stopBtn       = $('stop-btn');
const roomOverlay   = $('room-id-overlay');

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function genRoomId() {
  return 'ROOM-' + Math.random().toString(36).substring(2,6).toUpperCase();
}
function toast(msg, type='') {
  const t = document.createElement('div');
  t.className = 'toast ' + type;
  t.textContent = msg;
  $('toast-stack').prepend(t);
  setTimeout(() => t.remove(), 3200);
}
function setConn(cls, txt) {
  connStatus.className = cls;
  connText.textContent = txt;
}
function setAlert(type, msg) {
  alertBar.className = type === 'clear' ? '' : type + '-alert';
  alertText.textContent = msg;
  if (type !== 'clear') {
    alertFlash.className = type;
    alertFlash.style.opacity = '1';
    setTimeout(() => { alertFlash.style.opacity='0'; alertFlash.className=''; }, 600);
    setTimeout(() => setAlert('clear','No Alerts'), 4000);
  }
}
function updateSensitivity(v) {
  STATE.sensitivity = parseInt(v);
  $('sens-val').textContent = v;
  $('sensitivity').style.background = `linear-gradient(to right,var(--gold-dim) 0%,var(--gold-dim) ${v*10}%,var(--s3) ${v*10}%,var(--s3) 100%)`;
}
updateSensitivity(5);

// â”€â”€ ROLE SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchRole(role) {
  STATE.role = role;
  $('tab-camera').classList.toggle('active', role==='camera');
  $('tab-viewer').classList.toggle('active', role==='viewer');
  $('viewer-panel').classList.toggle('show', role==='viewer');
  startBtn.style.display = role==='camera' ? '' : 'none';
  stopBtn.style.display  = role==='camera' ? '' : 'none';
  $('sens-group').style.display = role==='camera' ? '' : 'none';
  if (role === 'viewer') {
    stopCamera();
    refreshRooms();
  } else {
    $('placeholder-msg').textContent = 'Tap Start Camera to begin';
  }
}

// â”€â”€ WEBSOCKET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectWS(cb) {
  if (STATE.ws && STATE.ws.readyState === WebSocket.OPEN) { cb && cb(); return; }
  let called = false;
  function done() { if (!called) { called=true; cb && cb(); } }
  try {
    STATE.ws = new WebSocket(CONFIG.WS_URL);
    STATE.ws.onopen  = () => { STATE.wsReady=true; done(); };
    STATE.ws.onerror = () => { STATE.wsReady=false; done(); };
    STATE.ws.onclose = () => { STATE.wsReady=false; };
    STATE.ws.onmessage = async e => {
      let m; try { m=JSON.parse(e.data); } catch { return; }
      await onSignal(m);
    };
    // If no response in 3s, proceed anyway
    setTimeout(done, 3000);
  } catch(e) { STATE.wsReady=false; done(); }
}
function wsSend(obj) {
  if (STATE.ws && STATE.ws.readyState===WebSocket.OPEN) STATE.ws.send(JSON.stringify(obj));
}

async function onSignal(m) {
  switch(m.type) {
    case 'room-created':
      setConn('live','Broadcasting');
      break;
    case 'rooms-list':
      STATE.activeRooms = m.rooms || [];
      renderRoomsList();
      break;
    case 'viewer-joined':
      toast('ğŸ‘ Viewer connected','success');
      await createOfferFor(m.viewerId);
      break;
    case 'viewer-left':
      if (STATE.peerConnections[m.viewerId]) {
        STATE.peerConnections[m.viewerId].close();
        delete STATE.peerConnections[m.viewerId];
      }
      break;
    case 'offer':
      await handleOffer(m);
      break;
    case 'answer':
      if (STATE.peerConnections[m.from])
        await STATE.peerConnections[m.from].setRemoteDescription(new RTCSessionDescription(m.sdp));
      break;
    case 'ice':
      const pc = STATE.role==='camera' ? STATE.peerConnections[m.from] : STATE.viewerPc;
      if (pc) try { await pc.addIceCandidate(new RTCIceCandidate(m.candidate)); } catch(e){}
      break;
    case 'alert':
      if (STATE.role==='viewer') {
        setAlert(m.alertType, m.message);
        toast('ğŸ”” '+m.message, m.alertType==='sound'?'error':'');
      }
      break;
    case 'error':
      toast('âš  '+m.message,'error');
      break;
  }
}

// â”€â”€ ACTIVE ROOMS LIST (Viewer side) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshRooms() {
  const list = $('active-rooms-list');
  list.innerHTML = '<div id="no-rooms" style="font-family:var(--font-mono);font-size:0.72rem;letter-spacing:0.1em;color:rgba(255,215,0,0.3);text-align:center;padding:10px;">Searching for cameras...</div>';
  connectWS(() => {
    if (STATE.wsReady) {
      wsSend({ type: 'list-rooms' });
      setTimeout(() => {
        if (STATE.activeRooms.length === 0) renderRoomsList();
      }, 2000);
    } else {
      list.innerHTML = '<div id="no-rooms" style="font-family:var(--font-mono);font-size:0.72rem;letter-spacing:0.1em;color:rgba(255,59,59,0.5);text-align:center;padding:10px;">âš  Server offline â€” start server to see cameras</div>';
    }
  });
}

function renderRoomsList() {
  const list = $('active-rooms-list');
  if (!STATE.activeRooms.length) {
    list.innerHTML = '<div style="font-family:var(--font-mono);font-size:0.72rem;letter-spacing:0.1em;color:rgba(255,215,0,0.3);text-align:center;padding:10px;">No active cameras found</div>';
    return;
  }
  list.innerHTML = '';
  STATE.activeRooms.forEach(room => {
    const card = document.createElement('div');
    card.className = 'room-card';
    card.innerHTML = `
      <div>
        <div class="rc-id">${room.id}</div>
        <div class="rc-status">LIVE Â· ${room.viewers} viewer${room.viewers!==1?'s':''}</div>
      </div>
      <button class="rc-watch" onclick="connectToRoom('${room.id}')">Watch</button>
    `;
    list.appendChild(card);
  });
}

function connectToRoom(roomId) {
  if (!STATE.wsReady) { toast('âš  Server offline','error'); return; }
  STATE.roomId = roomId;
  setConn('connecting','Connecting...');
  $('placeholder-msg').textContent = 'Connecting to ' + roomId + '...';
  wsSend({ type: 'join-room', roomId });
}

// â”€â”€ START CAMERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startCamera() {
  startBtn.disabled = true;
  setConn('connecting','Starting...');

  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  } catch(err) {
    // Try video only if audio fails
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      toast('Microphone unavailable â€” video only','');
    } catch(e) {
      startBtn.disabled = false;
      setConn('offline','Offline');
      toast('âš  Camera access denied','error');
      $('placeholder-msg').textContent = 'Camera access denied â€” check permissions';
      return;
    }
  }

  STATE.localStream = stream;
  STATE.roomId = genRoomId();

  // Show room ID on video immediately
  roomOverlay.textContent = STATE.roomId;
  roomOverlay.style.display = 'block';

  video.srcObject = stream;

  // Use both onloadedmetadata AND canplay for reliability
  function onReady() {
    video.removeEventListener('canplay', onReady);
    placeholder.style.display = 'none';
    liveBadge.style.display = 'flex';
    stopBtn.disabled = false;
    startBtn.textContent = 'Restart';
    startBtn.disabled = false;
    setConn('live','Live');
    setupMotionDetection();
    setupSoundDetection();
    connectWS(() => {
      if (STATE.wsReady) wsSend({ type: 'create-room', roomId: STATE.roomId });
    });
  }

  video.addEventListener('canplay', onReady);
  video.onloadedmetadata = () => video.play().catch(()=>{});

  // Fallback â€” if canplay doesn't fire in 2s, force it
  setTimeout(() => {
    if (placeholder.style.display !== 'none') onReady();
  }, 2000);
}

// â”€â”€ STOP CAMERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function stopCamera() {
  if (STATE.localStream) {
    STATE.localStream.getTracks().forEach(t => t.stop());
    STATE.localStream = null;
  }
  video.srcObject = null;
  liveBadge.style.display = 'none';
  placeholder.style.display = '';
  roomOverlay.style.display = 'none';
  roomOverlay.textContent = '';
  startBtn.disabled = false;
  startBtn.textContent = 'Start Camera';
  stopBtn.disabled = true;
  cancelAnimationFrame(STATE.frameLoop);
  if (STATE.audioCtx) { try { STATE.audioCtx.close(); } catch(e){} STATE.audioCtx = null; }
  STATE.prevFrame = null;
  Object.values(STATE.peerConnections).forEach(pc => pc.close());
  STATE.peerConnections = {};
  if (STATE.viewerPc) { STATE.viewerPc.close(); STATE.viewerPc = null; }
  if (STATE.wsReady) wsSend({ type: 'leave-room', roomId: STATE.roomId });
  setConn('offline','Offline');
  STATE.roomId = null;
  setAlert('clear','No Alerts');
  statMotion.textContent = 'MOTION: â€”';
  statSound.textContent  = 'SOUND: â€”';
}

// â”€â”€ WebRTC: CAMERA â†’ VIEWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function createOfferFor(viewerId) {
  const pc = new RTCPeerConnection({ iceServers: CONFIG.ICE_SERVERS });
  STATE.peerConnections[viewerId] = pc;
  STATE.localStream.getTracks().forEach(t => pc.addTrack(t, STATE.localStream));
  pc.onicecandidate = e => {
    if (e.candidate) wsSend({ type:'ice', to:viewerId, from:'camera', candidate:e.candidate });
  };
  pc.onconnectionstatechange = () => {
    if (pc.connectionState==='disconnected'||pc.connectionState==='failed') {
      pc.close(); delete STATE.peerConnections[viewerId];
    }
  };
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  wsSend({ type:'offer', to:viewerId, from:'camera', sdp:pc.localDescription });
}

// â”€â”€ WebRTC: VIEWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleOffer(m) {
  const pc = new RTCPeerConnection({ iceServers: CONFIG.ICE_SERVERS });
  STATE.viewerPc = pc;
  pc.ontrack = e => {
    if (e.streams && e.streams[0]) {
      video.srcObject = e.streams[0];
      placeholder.style.display = 'none';
      liveBadge.style.display = 'flex';
      setConn('viewer-live','Watching');
      toast('âœ“ Connected to '+STATE.roomId,'success');
    }
  };
  pc.onicecandidate = e => {
    if (e.candidate) wsSend({ type:'ice', to:m.from, from:'viewer', candidate:e.candidate, roomId:STATE.roomId });
  };
  pc.onconnectionstatechange = () => {
    if (pc.connectionState==='disconnected'||pc.connectionState==='failed') {
      setConn('offline','Disconnected');
      placeholder.style.display = '';
      video.srcObject = null;
      liveBadge.style.display = 'none';
      toast('Connection lost','error');
    }
  };
  await pc.setRemoteDescription(new RTCSessionDescription(m.sdp));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  wsSend({ type:'answer', to:m.from, from:'viewer', sdp:pc.localDescription, roomId:STATE.roomId });
}

// â”€â”€ MOTION DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupMotionDetection() {
  canvas.width=160; canvas.height=120;
  STATE.motionCtx = canvas.getContext('2d',{willReadFrequently:true});
  STATE.prevFrame = null;
  motionLoop();
}
function motionLoop() {
  if (!STATE.localStream) return;
  STATE.frameLoop = requestAnimationFrame(() => setTimeout(motionLoop, CONFIG.FRAME_MS));
  if (video.readyState < 2) return;
  const ctx = STATE.motionCtx;
  ctx.drawImage(video,0,0,160,120);
  const cur = ctx.getImageData(0,0,160,120);
  if (STATE.prevFrame) {
    const d1=STATE.prevFrame.data, d2=cur.data;
    let n=0; const total=d1.length/4;
    const thr = CONFIG.MOTION_THRESHOLD*(1-(STATE.sensitivity-1)/12);
    for (let i=0;i<d1.length;i+=4) {
      if ((Math.abs(d1[i]-d2[i])+Math.abs(d1[i+1]-d2[i+1])+Math.abs(d1[i+2]-d2[i+2]))/3>thr) n++;
    }
    const ratio=n/total;
    const lvl=Math.min(100,Math.round(ratio*4000));
    statMotion.textContent='MOTION: '+lvl+'%';
    statMotion.classList.toggle('hot',lvl>25);
    const now=Date.now();
    if (ratio>CONFIG.MOTION_PIXEL_PCT*(1-(STATE.sensitivity-1)/14) && now-STATE.lastMotion>CONFIG.MOTION_COOLDOWN) {
      STATE.lastMotion=now; triggerAlert('motion','âš¡ Motion Detected');
    }
  }
  STATE.prevFrame=cur;
}

// â”€â”€ SOUND DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupSoundDetection() {
  try {
    STATE.audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const src = STATE.audioCtx.createMediaStreamSource(STATE.localStream);
    STATE.analyser = STATE.audioCtx.createAnalyser();
    STATE.analyser.fftSize=512;
    src.connect(STATE.analyser);
    soundLoop();
  } catch(e) { console.warn('Audio unavailable'); }
}
function soundLoop() {
  if (!STATE.audioCtx) return;
  requestAnimationFrame(soundLoop);
  const data=new Uint8Array(STATE.analyser.frequencyBinCount);
  STATE.analyser.getByteFrequencyData(data);
  let sum=0; for(let i=0;i<data.length;i++) sum+=data[i];
  const avg=sum/data.length/255;
  const lvl=Math.min(100,Math.round(avg*400));
  statSound.textContent='SOUND: '+lvl+'%';
  statSound.classList.toggle('hot',lvl>30);
  const now=Date.now();
  const thr=CONFIG.SOUND_THRESHOLD*(1-(STATE.sensitivity-1)/13);
  if (avg>thr && now-STATE.lastSound>CONFIG.SOUND_COOLDOWN) {
    STATE.lastSound=now; triggerAlert('sound','ğŸ”Š Sound Detected');
  }
}

// â”€â”€ ALERT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function triggerAlert(type, msg) {
  setAlert(type, msg);
  toast('ğŸ”” '+msg, type==='sound'?'error':'');
  if (STATE.wsReady && STATE.roomId)
    wsSend({ type:'alert', roomId:STATE.roomId, alertType:type, message:msg });
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
switchRole('camera');
</script>
</body>
</html>
