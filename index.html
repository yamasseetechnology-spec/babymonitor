<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Yamassee Smart Monitor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root{
  --gold:#FFD700;--gold-dim:#B8960C;--gold-glow:rgba(255,215,0,0.22);
  --red:#FF3B3B;--red-glow:rgba(255,59,59,0.35);
  --green:#39FF14;--green-glow:rgba(57,255,20,0.3);
  --bg:#070707;--s1:#0E0E0E;--s2:#151515;--s3:#1C1C1C;
  --border:rgba(255,215,0,0.13);
  --ui:'Rajdhani',sans-serif;--mono:'Share Tech Mono',monospace;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--gold);font-family:var(--ui);}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background:repeating-linear-gradient(to bottom,transparent 0,transparent 3px,rgba(0,0,0,0.05) 3px,rgba(0,0,0,0.05) 4px);}
#app{display:flex;flex-direction:column;height:100vh;height:100dvh;overflow:hidden;}
#top-bar{display:flex;justify-content:space-between;align-items:center;padding:9px 14px;
  background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;position:relative;}
#top-bar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--gold-dim),transparent);}
#logo{height:34px;filter:drop-shadow(0 0 8px var(--gold-glow));}
#status{display:flex;align-items:center;gap:6px;font-family:var(--mono);font-size:0.68rem;
  letter-spacing:0.1em;text-transform:uppercase;padding:4px 10px;background:var(--s2);
  border:1px solid var(--border);border-radius:20px;color:rgba(255,215,0,0.45);transition:all 0.3s;}
#status .dot{width:7px;height:7px;border-radius:50%;background:rgba(255,215,0,0.2);flex-shrink:0;transition:all 0.3s;}
#status.live .dot{background:var(--green);box-shadow:0 0 8px var(--green-glow);animation:pulse 1.5s infinite;}
#status.live{color:var(--gold);border-color:rgba(255,215,0,0.3);}
#status.watch .dot{background:#7DF9FF;box-shadow:0 0 8px rgba(125,249,255,0.4);animation:pulse 1.5s infinite;}
#status.watch{color:#7DF9FF;border-color:rgba(125,249,255,0.3);}
#status.busy .dot{background:var(--gold);animation:pulse 0.8s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.3;transform:scale(0.6)}}
#tabs{display:flex;gap:6px;padding:7px 14px;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;}
.tab{flex:1;padding:7px 8px;font-family:var(--ui);font-size:0.82rem;font-weight:600;letter-spacing:0.07em;
  text-transform:uppercase;background:var(--s2);color:rgba(255,215,0,0.45);border:1px solid var(--border);
  border-radius:8px;cursor:pointer;transition:all 0.2s;min-height:44px;}
.tab.on{background:rgba(255,215,0,0.08);color:var(--gold);border-color:var(--gold-dim);box-shadow:0 0 14px rgba(255,215,0,0.1);}
.tab:hover:not(.on){background:var(--s3);color:var(--gold);}
#connect-panel{display:none;flex-direction:column;gap:10px;padding:12px 14px;
  background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;}
#connect-panel.show{display:flex;}
#room-display{display:none;flex-direction:column;gap:6px;}
#room-label{font-family:var(--mono);font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;color:rgba(255,215,0,0.45);}
#room-code-wrap{display:flex;align-items:center;gap:12px;}
#room-code{font-family:var(--mono);font-size:2.6rem;font-weight:700;letter-spacing:0.35em;
  color:var(--gold);text-shadow:0 0 24px var(--gold-glow);}
#btn-copy-room{flex-shrink:0;height:40px;padding:0 14px;font-family:var(--ui);font-size:0.82rem;font-weight:700;
  text-transform:uppercase;background:rgba(255,215,0,0.1);color:var(--gold);
  border:1px solid var(--gold-dim);border-radius:8px;cursor:pointer;}
#room-wait{font-family:var(--mono);font-size:0.68rem;letter-spacing:0.08em;
  color:rgba(255,215,0,0.55);display:flex;align-items:center;gap:6px;}
#room-wait .rdot{width:6px;height:6px;border-radius:50%;background:var(--gold);animation:pulse 1s infinite;}
#join-wrap{display:none;flex-direction:column;gap:8px;}
#join-label{font-family:var(--mono);font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;color:rgba(255,215,0,0.45);}
#join-row{display:flex;gap:8px;align-items:stretch;}
#room-input{flex:1;background:var(--s2);color:var(--gold);border:1px solid var(--border);
  border-radius:8px;font-family:var(--mono);font-size:1.6rem;font-weight:700;letter-spacing:0.3em;
  padding:8px 14px;outline:none;text-transform:uppercase;text-align:center;}
#room-input:focus{border-color:var(--gold-dim);}
#room-input::placeholder{color:rgba(255,215,0,0.15);font-size:0.85rem;letter-spacing:0.1em;}
#btn-join{padding:0 20px;font-family:var(--ui);font-size:0.9rem;font-weight:700;letter-spacing:0.08em;
  text-transform:uppercase;background:rgba(57,255,20,0.08);color:var(--green);
  border:1px solid rgba(57,255,20,0.4);border-radius:8px;cursor:pointer;transition:all 0.2s;white-space:nowrap;}
#btn-join:hover{background:rgba(57,255,20,0.18);}
#cam-section{flex:1;min-height:0;display:flex;flex-direction:column;padding:10px 14px 6px;}
#cam-wrap{flex:1;min-height:0;position:relative;border-radius:20px;overflow:hidden;border:1px solid var(--border);background:#000;}
#cam-wrap::before,#cam-wrap::after{content:'';position:absolute;width:18px;height:18px;
  border-color:rgba(255,215,0,0.5);border-style:solid;z-index:10;pointer-events:none;}
#cam-wrap::before{top:10px;left:10px;border-width:2px 0 0 2px;border-radius:3px 0 0 0;}
#cam-wrap::after{bottom:10px;right:10px;border-width:0 2px 2px 0;border-radius:0 0 3px 0;}
#feed{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;border-radius:20px;background:#000;z-index:1;}
#mcanvas{position:absolute;top:0;left:0;width:0;height:0;visibility:hidden;}
#empty{position:absolute;top:0;left:0;width:100%;height:100%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;
  border-radius:20px;background:var(--s1);z-index:5;}
#empty.hidden{display:none !important;}
#empty svg{opacity:0.13;width:56px;height:56px;}
#emsg{font-family:var(--mono);font-size:0.7rem;letter-spacing:0.12em;text-transform:uppercase;
  color:rgba(255,215,0,0.28);text-align:center;padding:0 24px;line-height:1.9;}
#livebadge{position:absolute;bottom:14px;left:14px;display:none;align-items:center;gap:6px;
  background:rgba(0,0,0,0.78);backdrop-filter:blur(6px);border:1px solid rgba(255,59,59,0.5);
  border-radius:8px;padding:4px 10px;font-family:var(--mono);font-size:0.68rem;letter-spacing:0.14em;color:#fff;z-index:8;}
#livebadge .ldot{width:7px;height:7px;border-radius:50%;background:var(--red);box-shadow:0 0 7px var(--red-glow);animation:blink 1.2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.1}}
#stats{position:absolute;bottom:14px;right:14px;display:flex;flex-direction:column;align-items:flex-end;gap:4px;z-index:8;pointer-events:none;}
.chip{background:rgba(0,0,0,0.75);backdrop-filter:blur(6px);border:1px solid var(--border);
  border-radius:6px;padding:3px 8px;font-family:var(--mono);font-size:0.62rem;letter-spacing:0.09em;color:rgba(255,215,0,0.5);}
.chip.hot{border-color:rgba(255,59,59,0.5);color:var(--red);background:rgba(255,59,59,0.12);}
#flash{position:absolute;inset:0;border-radius:20px;pointer-events:none;z-index:7;opacity:0;transition:opacity 0.1s;}
#flash.motion{background:radial-gradient(ellipse at center,rgba(255,215,0,0.12) 0%,transparent 70%);border:2px solid rgba(255,215,0,0.4);}
#flash.sound{background:radial-gradient(ellipse at center,rgba(255,59,59,0.12) 0%,transparent 70%);border:2px solid rgba(255,59,59,0.4);}
#ctrl{display:flex;flex-wrap:wrap;align-items:center;gap:8px;padding:8px 0 4px;flex-shrink:0;}
.btn{padding:0 16px;height:44px;font-family:var(--ui);font-size:0.88rem;font-weight:700;
  letter-spacing:0.08em;text-transform:uppercase;background:var(--s2);color:var(--gold);
  border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;white-space:nowrap;flex-shrink:0;}
.btn:hover{background:var(--s3);box-shadow:0 0 16px var(--gold-glow);border-color:rgba(255,215,0,0.35);}
.btn:active{transform:scale(0.97);}
.btn.primary{background:rgba(255,215,0,0.1);border-color:var(--gold-dim);box-shadow:0 0 14px var(--gold-glow);}
.btn.danger{border-color:rgba(255,59,59,0.4);color:var(--red);}
.btn:disabled{opacity:0.35;cursor:not-allowed;transform:none;}
#sensbox{display:flex;flex-direction:column;gap:3px;flex:1;min-width:110px;}
#senslbl{font-family:var(--mono);font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;
  color:rgba(255,215,0,0.45);display:flex;justify-content:space-between;}
#senslbl span{color:var(--gold);}
#sens{-webkit-appearance:none;appearance:none;width:100%;height:4px;border-radius:2px;outline:none;cursor:pointer;}
#sens::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;
  background:var(--gold);border:2px solid var(--bg);box-shadow:0 0 8px var(--gold-glow);cursor:pointer;}
#alertbar{width:100%;padding:7px 12px;background:var(--s2);border:1px solid var(--border);
  border-radius:8px;font-family:var(--mono);font-size:0.72rem;letter-spacing:0.09em;
  color:rgba(255,215,0,0.45);display:flex;align-items:center;gap:8px;transition:all 0.3s;}
#alertbar .adot{width:7px;height:7px;border-radius:50%;background:rgba(255,215,0,0.25);flex-shrink:0;transition:all 0.3s;}
#alertbar.motion-alert{border-color:rgba(255,215,0,0.45);color:var(--gold);background:rgba(255,215,0,0.07);}
#alertbar.motion-alert .adot{background:var(--gold);box-shadow:0 0 8px var(--gold-glow);animation:pulse 0.8s infinite;}
#alertbar.sound-alert{border-color:rgba(255,59,59,0.5);color:var(--red);background:rgba(255,59,59,0.07);}
#alertbar.sound-alert .adot{background:var(--red);box-shadow:0 0 8px var(--red-glow);animation:pulse 0.8s infinite;}
#toasts{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:1000;
  display:flex;flex-direction:column-reverse;gap:6px;pointer-events:none;width:calc(100% - 28px);max-width:420px;}
.toast{padding:10px 14px;border-radius:8px;font-family:var(--mono);font-size:0.75rem;
  letter-spacing:0.08em;background:rgba(14,14,14,0.97);border:1px solid var(--border);
  backdrop-filter:blur(10px);color:var(--gold);
  animation:tin 0.25s ease,tout 0.3s ease 2.7s forwards;box-shadow:0 4px 20px rgba(0,0,0,0.5);}
.toast.err{border-color:rgba(255,59,59,0.5);color:var(--red);}
.toast.ok{border-color:rgba(57,255,20,0.4);color:var(--green);}
@keyframes tin{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes tout{from{opacity:1}to{opacity:0}}
@media(min-width:600px){#ctrl{flex-wrap:nowrap;}#alertbar{width:auto;flex:1;}}
</style>
</head>
<body>
<div id="app">
  <div id="top-bar">
    <img id="logo" src="https://i.ibb.co/gFMKLNWd/Chat-GPT-Image-Dec-31-2025-01-45-02-AM-Photoroom.png" alt="Yamassee">
    <div id="status"><div class="dot"></div><span id="stxt">Offline</span></div>
  </div>
  <div id="tabs">
    <button class="tab on" id="tcam" onclick="setRole('camera')">ğŸ“· Room Camera</button>
    <button class="tab" id="tview" onclick="setRole('viewer')">ğŸ‘ Viewer</button>
  </div>
  <div id="connect-panel">
    <div id="room-display">
      <div id="room-label">Room Code â€” give this to the Viewer:</div>
      <div id="room-code-wrap">
        <div id="room-code">------</div>
        <button id="btn-copy-room" onclick="copyCode()">ğŸ“‹ Copy</button>
      </div>
      <div id="room-wait"><div class="rdot"></div><span id="room-wait-txt">Waiting for viewer...</span></div>
    </div>
    <div id="join-wrap">
      <div id="join-label">Enter the 6-character Room Code from the Camera:</div>
      <div id="join-row">
        <input id="room-input" type="text" maxlength="6" placeholder="ABC123"
          autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"
          oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')">
        <button id="btn-join" onclick="joinRoom()">Connect â–¶</button>
      </div>
    </div>
  </div>
  <div id="cam-section">
    <div id="cam-wrap">
      <video id="feed" autoplay playsinline muted></video>
      <canvas id="mcanvas"></canvas>
      <div id="empty">
        <svg viewBox="0 0 64 64" fill="none">
          <rect x="4" y="14" width="56" height="36" rx="6" stroke="#FFD700" stroke-width="2.5"/>
          <circle cx="32" cy="32" r="9" stroke="#FFD700" stroke-width="2.5"/>
          <rect x="22" y="10" width="20" height="6" rx="3" stroke="#FFD700" stroke-width="2"/>
          <circle cx="52" cy="22" r="3" fill="#FFD700" opacity="0.6"/>
        </svg>
        <p id="emsg">Tap Start Camera to begin</p>
      </div>
      <div id="livebadge"><div class="ldot"></div>LIVE</div>
      <div id="stats">
        <div class="chip" id="smot">MOTION: â€”</div>
        <div class="chip" id="ssnd">SOUND: â€”</div>
      </div>
      <div id="flash"></div>
    </div>
    <div id="ctrl">
      <button class="btn primary" id="bstart" onclick="startCam()">Start Camera</button>
      <button class="btn danger" id="bstop" onclick="stopAll()" disabled>Stop</button>
      <div id="sensbox">
        <div id="senslbl">Sensitivity <span id="sval">5</span></div>
        <input type="range" id="sens" min="1" max="10" value="5" oninput="setSens(this.value)">
      </div>
      <div id="alertbar"><div class="adot"></div><span id="alrt">No Alerts</span></div>
    </div>
  </div>
</div>
<div id="toasts"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  YAMASSEE SMART MONITOR
//
//  RELAY: HiveMQ public MQTT broker (free, no account, WebSocket)
//         broker.hivemq.com:8884 â€” WSS
//         MQTT.js loaded from cdnjs above
//
//  SIGNALING:
//    Camera generates 6-char code â†’ publishes offer to topic
//    Viewer types code â†’ subscribes to topic â†’ gets offer instantly
//    Viewer publishes answer â†’ camera gets it â†’ WebRTC connects
//
//  DETECTION (viewer side):
//    Motion: canvas pixel diff on remote video â€” no permissions needed
//    Sound:  AudioContext created inside Connect button tap (user gesture)
//            Connected to remote stream audio track when track arrives
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var BROKER  = 'wss://broker.hivemq.com:8884/mqtt';
var TOPIC   = 'yamassee-monitor-v3/';   // prefix for all topics

var ICE = { iceServers: [
  { urls: 'stun:stun.l.google.com:19302' },
  { urls: 'stun:stun1.l.google.com:19302' },
  { urls: 'stun:stun2.l.google.com:19302' },
  { urls: 'stun:stun3.l.google.com:19302' },
  { urls: 'turn:openrelay.metered.ca:80',                username:'openrelayproject',credential:'openrelayproject'},
  { urls: 'turn:openrelay.metered.ca:443',               username:'openrelayproject',credential:'openrelayproject'},
  { urls: 'turn:openrelay.metered.ca:443?transport=tcp', username:'openrelayproject',credential:'openrelayproject'}
]};

// DOM
var feed        = document.getElementById('feed');
var mcanvas     = document.getElementById('mcanvas');
var empty       = document.getElementById('empty');
var emsg        = document.getElementById('emsg');
var livebadge   = document.getElementById('livebadge');
var flashEl     = document.getElementById('flash');
var statusEl    = document.getElementById('status');
var stxt        = document.getElementById('stxt');
var smot        = document.getElementById('smot');
var ssnd        = document.getElementById('ssnd');
var alrt        = document.getElementById('alrt');
var alertbar    = document.getElementById('alertbar');
var bstart      = document.getElementById('bstart');
var bstop       = document.getElementById('bstop');
var roomCodeEl  = document.getElementById('room-code');
var roomWaitTxt = document.getElementById('room-wait-txt');

// State
var ROLE     = 'camera';
var pc       = null;
var stream   = null;
var mqCl     = null;   // MQTT client
var roomCode = null;
var actx     = null;   // AudioContext â€” created inside button tap only
var analyser = null;
var sens     = 5;
var mctx     = null;
var prev     = null;
var floop    = null;
var tLM      = 0;
var tLS      = 0;

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function toast(msg, cls) {
  var d = document.createElement('div');
  d.className = 'toast ' + (cls||'');
  d.textContent = msg;
  document.getElementById('toasts').prepend(d);
  setTimeout(function(){ if(d.parentNode) d.parentNode.removeChild(d); }, 3500);
}
function setStat(c,t){ statusEl.className=c||''; stxt.textContent=t; }
function showEmpty(m){ emsg.textContent=m; empty.classList.remove('hidden'); }
function hideEmpty() { empty.classList.add('hidden'); }

function setAlert(type, msg) {
  if (type==='clear'){ alertbar.className=''; alrt.textContent='No Alerts'; return; }
  alertbar.className = type+'-alert';
  alrt.textContent = msg||type;
  flashEl.className = type; flashEl.style.opacity='1';
  setTimeout(function(){ flashEl.style.opacity='0'; flashEl.className=''; }, 700);
  setTimeout(function(){ setAlert('clear'); }, 4000);
}

function setSens(v) {
  sens=parseInt(v);
  document.getElementById('sval').textContent=v;
  var p=v*10;
  document.getElementById('sens').style.background=
    'linear-gradient(to right,var(--gold-dim) 0%,var(--gold-dim) '+p+'%,var(--s3) '+p+'%,var(--s3) 100%)';
}
setSens(5);

function makeCode() {
  var c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789', s='';
  for(var i=0;i<6;i++) s+=c[Math.floor(Math.random()*c.length)];
  return s;
}

function copyCode(){
  if(!roomCode) return;
  if(navigator.clipboard&&navigator.clipboard.writeText)
    navigator.clipboard.writeText(roomCode).then(function(){ toast('Copied: '+roomCode,'ok'); });
  else toast('Code: '+roomCode,'ok');
}

function waitForICE(p) {
  return new Promise(function(resolve){
    if(p.iceGatheringState==='complete'){ resolve(); return; }
    var done=false;
    function fin(){ if(!done){ done=true; resolve(); } }
    p.addEventListener('icegatheringstatechange',function(){ if(p.iceGatheringState==='complete') fin(); });
    setTimeout(fin, 6000);
  });
}

// â”€â”€â”€ MQTT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function mqConnect(onReady) {
  if (mqCl) { try{ mqCl.end(true); }catch(e){} mqCl=null; }

  setStat('busy', 'Connecting to relay...');
  var cid = 'ym-'+(Math.random().toString(36).substr(2,9));

  mqCl = mqtt.connect(BROKER, {
    clientId: cid,
    clean: true,
    keepalive: 30,
    reconnectPeriod: 0,
    connectTimeout: 8000
  });

  mqCl.on('connect', function(){
    setStat('busy', 'Relay connected');
    onReady();
  });

  mqCl.on('error', function(e){
    toast('Relay error: '+e.message,'err');
    setStat('','Offline');
    bstart.disabled=false;
    bstart.textContent='Start Camera';
    document.getElementById('btn-join').disabled=false;
  });

  mqCl.on('close', function(){
    // only log â€” don't error if we deliberately closed
  });
}

function mqSend(subtopic, payload) {
  // retain=true so late subscriber gets it immediately
  if(!mqCl) return;
  mqCl.publish(TOPIC+subtopic, JSON.stringify(payload), {qos:1, retain:true});
}

function mqClearRetain(subtopic) {
  if(!mqCl) return;
  // Empty retained payload clears it from broker
  mqCl.publish(TOPIC+subtopic, '', {qos:1, retain:true});
}

function mqListen(subtopic, cb) {
  if(!mqCl) return;
  var full = TOPIC+subtopic;
  mqCl.subscribe(full, {qos:1});
  mqCl.on('message', function(t, buf){
    if(t!==full) return;
    if(!buf||buf.length===0) return; // empty = retain clear, ignore
    try { cb(JSON.parse(buf.toString())); } catch(e){}
  });
}

function mqStop() {
  if(mqCl){ try{ mqCl.end(true); }catch(e){} mqCl=null; }
}

// â”€â”€â”€ ROLE SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function setRole(r) {
  ROLE=r;
  document.getElementById('tcam').classList.toggle('on',r==='camera');
  document.getElementById('tview').classList.toggle('on',r==='viewer');
  bstart.style.display=r==='camera'?'':'none';
  bstop.style.display=r==='camera'?'':'none';
  document.getElementById('sensbox').style.display=r==='camera'?'':'none';
  stopAll();
  if(r==='viewer'){
    document.getElementById('connect-panel').classList.add('show');
    document.getElementById('room-display').style.display='none';
    document.getElementById('join-wrap').style.display='flex';
    showEmpty('Type the room code above and tap Connect');
  } else {
    document.getElementById('connect-panel').classList.remove('show');
    showEmpty('Tap Start Camera to begin');
  }
}

// â”€â”€â”€ CAMERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function startCam() {
  bstart.disabled=true;
  setStat('busy','Starting...');
  showEmpty('Requesting camera...');

  navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:true})
    .catch(function(){ return navigator.mediaDevices.getUserMedia({video:true,audio:false}); })
    .then(function(s){
      stream=s;
      feed.srcObject=stream; feed.muted=true;
      var p=feed.play(); if(p) p.catch(function(){});
      hideEmpty();
      livebadge.style.display='flex';
      bstop.disabled=false;
      bstart.disabled=false; bstart.textContent='Restart';
      // Connect MQTT then set up WebRTC
      mqConnect(function(){ setupCameraPC(); });
    })
    .catch(function(e){
      bstart.disabled=false; setStat('','Offline');
      showEmpty('Camera denied â€” check browser permissions');
      toast('Camera error: '+e.message,'err');
    });
}

function setupCameraPC() {
  roomCode = makeCode();
  var offerTopic  = roomCode+'/offer';
  var answerTopic = roomCode+'/answer';

  // Clear any old retained messages for this code
  mqClearRetain(offerTopic);
  mqClearRetain(answerTopic);

  pc = new RTCPeerConnection(ICE);
  stream.getTracks().forEach(function(t){ pc.addTrack(t,stream); });

  pc.onconnectionstatechange=function(){
    if(pc.connectionState==='connected'){
      setStat('live','Broadcasting');
      // Clean up retained MQTT messages
      mqClearRetain(offerTopic);
      mqClearRetain(answerTopic);
      document.getElementById('connect-panel').classList.remove('show');
      toast('Viewer connected â€” live!','ok');
    }
    if(pc.connectionState==='disconnected'||pc.connectionState==='failed'){
      setStat('busy','Viewer left');
      toast('Viewer disconnected','');
    }
  };

  setStat('busy','Building offer...');
  pc.createOffer()
    .then(function(o){ return pc.setLocalDescription(o); })
    .then(function(){
      setStat('busy','Gathering ICE...');
      return waitForICE(pc);
    })
    .then(function(){
      // Subscribe to answer BEFORE publishing offer (avoid race)
      mqListen(answerTopic, function(data){
        if(!pc || pc.signalingState!=='have-local-offer') return;
        setStat('busy','Viewer found â€” connecting...');
        roomWaitTxt.textContent='Viewer found â€” connecting...';
        pc.setRemoteDescription(new RTCSessionDescription(data))
          .catch(function(e){ toast('Connect error: '+e.message,'err'); });
      });

      // Publish offer with retain so viewer gets it the moment they subscribe
      mqSend(offerTopic, {type:pc.localDescription.type, sdp:pc.localDescription.sdp});

      // Show room code â€” we only get here if MQTT connected successfully
      roomCodeEl.textContent=roomCode;
      document.getElementById('connect-panel').classList.add('show');
      document.getElementById('room-display').style.display='flex';
      roomWaitTxt.textContent='Waiting for viewer to join...';
      setStat('busy','Waiting for viewer...');
      toast('Room ready â€” Code: '+roomCode,'ok');
    })
    .catch(function(e){
      setStat('','Offline');
      showEmpty('Tap Start Camera to begin');
      bstart.disabled=false; bstart.textContent='Start Camera';
      toast('Setup failed: '+e.message,'err');
    });
}

// â”€â”€â”€ VIEWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function joinRoom() {
  var code=document.getElementById('room-input').value.trim().toUpperCase();
  if(code.length!==6){ toast('Enter all 6 characters','err'); return; }

  // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
  // AudioContext MUST be created here â€” inside the button click handler.
  // This is the ONLY moment Android Chrome allows it without blocking.
  // We create it now, store globally, plug the audio stream in later.
  // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
  try {
    if(actx){ try{actx.close();}catch(e){} actx=null; }
    actx = new (window.AudioContext||window.webkitAudioContext)();
    actx.resume();  // succeeds because we're inside a real click event
  } catch(e){ actx=null; console.warn('AudioContext:',e); }

  document.getElementById('btn-join').disabled=true;
  setStat('busy','Connecting to relay...');
  showEmpty('Connecting...');

  mqConnect(function(){ setupViewerPC(code); });
}

function setupViewerPC(code) {
  if(pc){ try{pc.close();}catch(e){} pc=null; }
  stopDetect();

  var offerTopic  = code+'/offer';
  var answerTopic = code+'/answer';

  pc = new RTCPeerConnection(ICE);
  var gotTrack=false;

  pc.ontrack=function(evt){
    var s=(evt.streams&&evt.streams[0])?evt.streams[0]:new MediaStream([evt.track]);
    feed.srcObject=s; feed.muted=false;
    var p=feed.play(); if(p) p.catch(function(){});
    hideEmpty();
    livebadge.style.display='flex';
    setStat('watch','Watching');
    if(!gotTrack){
      gotTrack=true;
      document.getElementById('connect-panel').classList.remove('show');
      toast('Live feed connected!','ok');
      // actx is already running (created in button tap above)
      startDetect(s);
    }
  };

  pc.onconnectionstatechange=function(){
    if(pc.connectionState==='disconnected'||pc.connectionState==='failed'){
      feed.srcObject=null;
      showEmpty('Camera disconnected');
      livebadge.style.display='none';
      setStat('','Disconnected');
      stopDetect();
      toast('Camera feed ended','err');
    }
  };

  // Subscribe to offer topic â€” retained message arrives immediately
  setStat('busy','Waiting for camera offer...');
  mqListen(offerTopic, function(offerData){
    if(!pc||pc.signalingState!=='stable') return; // only process once

    showEmpty('Offer received â€” connecting...');
    pc.setRemoteDescription(new RTCSessionDescription(offerData))
      .then(function(){ return pc.createAnswer(); })
      .then(function(a){ return pc.setLocalDescription(a); })
      .then(function(){
        setStat('busy','Finalizing...');
        return waitForICE(pc);
      })
      .then(function(){
        mqSend(answerTopic, {type:pc.localDescription.type, sdp:pc.localDescription.sdp});
        setStat('busy','Waiting for video...');
        showEmpty('Connected â€” video starting...');
        document.getElementById('btn-join').disabled=false;
      })
      .catch(function(e){
        document.getElementById('btn-join').disabled=false;
        setStat('','Offline');
        showEmpty('Type the room code above and tap Connect');
        toast('Failed: '+e.message,'err');
      });
  });
}

// â”€â”€â”€ STOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function stopAll() {
  stopDetect();
  mqStop();
  if(pc){ try{pc.close();}catch(e){} pc=null; }
  if(stream){ stream.getTracks().forEach(function(t){t.stop();}); stream=null; }
  feed.srcObject=null; feed.muted=true;
  livebadge.style.display='none';
  bstart.disabled=false; bstart.textContent='Start Camera';
  bstop.disabled=true;
  setStat('','Offline'); setAlert('clear');
  smot.textContent='MOTION: â€”'; smot.classList.remove('hot');
  ssnd.textContent='SOUND: â€”';  ssnd.classList.remove('hot');
  roomCode=null; roomCodeEl.textContent='------';
  document.getElementById('connect-panel').classList.remove('show');
  document.getElementById('btn-join').disabled=false;
}

// â”€â”€â”€ DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function startDetect(s) {
  stopDetect();

  // MOTION â€” canvas pixel diff, works on any stream
  mcanvas.width=160; mcanvas.height=120;
  mctx=mcanvas.getContext('2d',{willReadFrequently:true});
  prev=null;
  motionLoop();

  // SOUND â€” plug stream into actx that was created in joinRoom() click handler
  if(actx) {
    try {
      var tracks=s.getAudioTracks();
      if(tracks.length>0) {
        var src=actx.createMediaStreamSource(new MediaStream([tracks[0]]));
        analyser=actx.createAnalyser();
        analyser.fftSize=512;
        src.connect(analyser);
        soundLoop();
      } else {
        ssnd.textContent='SOUND: no audio';
      }
    } catch(e) {
      console.warn('Sound detect error:',e);
      ssnd.textContent='SOUND: error';
    }
  } else {
    ssnd.textContent='SOUND: unavailable';
  }
}

function stopDetect() {
  if(floop){ cancelAnimationFrame(floop); floop=null; }
  if(analyser){ analyser=null; }
  if(actx){ try{actx.close();}catch(e){} actx=null; }
  prev=null;
}

function motionLoop() {
  if(!feed.srcObject){
    floop=requestAnimationFrame(function(){ setTimeout(motionLoop,300); });
    return;
  }
  floop=requestAnimationFrame(function(){ setTimeout(motionLoop,120); });
  if(feed.readyState<2) return;
  try { mctx.drawImage(feed,0,0,160,120); } catch(e){ return; }
  var cur=mctx.getImageData(0,0,160,120);
  if(prev){
    var d1=prev.data, d2=cur.data, n=0;
    var thr=28*(1-(sens-1)/12);
    for(var i=0;i<d1.length;i+=4)
      if((Math.abs(d1[i]-d2[i])+Math.abs(d1[i+1]-d2[i+1])+Math.abs(d1[i+2]-d2[i+2]))/3>thr) n++;
    var ratio=n/(d1.length/4);
    var lvl=Math.min(100,Math.round(ratio*4500));
    smot.textContent='MOTION: '+lvl+'%';
    smot.classList.toggle('hot',lvl>25);
    var now=Date.now();
    if(ratio>0.012*(1-(sens-1)/14) && now-tLM>2500){
      tLM=now; fireAlert('motion','Motion Detected');
    }
  }
  prev=cur;
}

function soundLoop() {
  if(!actx||!analyser) return;
  requestAnimationFrame(soundLoop);
  var data=new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(data);
  var sum=0;
  for(var i=0;i<data.length;i++) sum+=data[i];
  var avg=sum/data.length/255;
  var lvl=Math.min(100,Math.round(avg*500));
  ssnd.textContent='SOUND: '+lvl+'%';
  ssnd.classList.toggle('hot',lvl>30);
  var now=Date.now();
  if(avg>0.10*(1-(sens-1)/13) && now-tLS>2000){
    tLS=now; fireAlert('sound','Sound Detected');
  }
}

function fireAlert(type,msg){
  setAlert(type,msg);
  toast(msg, type==='sound'?'err':'');
}

setRole('camera');
</script>
</body>
</html>
