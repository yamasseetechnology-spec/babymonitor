<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Yamassee Smart Monitor</title>
<!-- PeerJS ‚Äî free hosted WebRTC signaling, no server needed -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root{
  --gold:#FFD700;--gold-dim:#B8960C;--gold-glow:rgba(255,215,0,0.22);
  --red:#FF3B3B;--red-glow:rgba(255,59,59,0.35);
  --green:#39FF14;--green-glow:rgba(57,255,20,0.3);
  --bg:#070707;--s1:#0E0E0E;--s2:#151515;--s3:#1C1C1C;
  --border:rgba(255,215,0,0.13);
  --font-ui:'Rajdhani',sans-serif;--font-mono:'Share Tech Mono',monospace;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--gold);font-family:var(--font-ui);}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background:repeating-linear-gradient(to bottom,transparent 0px,transparent 3px,rgba(0,0,0,0.05) 3px,rgba(0,0,0,0.05) 4px);}
#app{display:flex;flex-direction:column;height:100vh;height:100dvh;overflow:hidden;}

/* TOP BAR */
#top-bar{display:flex;justify-content:space-between;align-items:center;padding:9px 14px;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;position:relative;}
#top-bar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold-dim),transparent);}
#logo{height:34px;width:auto;filter:drop-shadow(0 0 8px var(--gold-glow));}
#conn-status{display:flex;align-items:center;gap:6px;font-family:var(--font-mono);font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;padding:4px 10px;background:var(--s2);border:1px solid var(--border);border-radius:20px;color:rgba(255,215,0,0.45);transition:all 0.3s;}
#conn-status .dot{width:7px;height:7px;border-radius:50%;background:rgba(255,215,0,0.25);flex-shrink:0;transition:all 0.3s;}
#conn-status.live .dot{background:var(--green);box-shadow:0 0 8px var(--green-glow);animation:pdot 1.5s infinite;}
#conn-status.live{color:var(--gold);border-color:rgba(255,215,0,0.3);}
#conn-status.connecting .dot{background:var(--gold);animation:pdot 0.9s infinite;}
#conn-status.watching .dot{background:#7DF9FF;box-shadow:0 0 8px rgba(125,249,255,0.4);animation:pdot 1.5s infinite;}
#conn-status.watching{color:#7DF9FF;border-color:rgba(125,249,255,0.3);}
@keyframes pdot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.3;transform:scale(0.65)}}

/* TABS */
#role-tabs{display:flex;gap:6px;padding:7px 14px;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;}
.rtab{flex:1;padding:7px 8px;font-family:var(--font-ui);font-size:0.82rem;font-weight:600;letter-spacing:0.07em;text-transform:uppercase;background:var(--s2);color:rgba(255,215,0,0.45);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;min-height:44px;}
.rtab.active{background:rgba(255,215,0,0.08);color:var(--gold);border-color:var(--gold-dim);box-shadow:0 0 14px rgba(255,215,0,0.1);}
.rtab:hover:not(.active){background:var(--s3);color:var(--gold);}

/* VIEWER CONNECT PANEL */
#viewer-panel{display:none;align-items:center;gap:8px;padding:10px 14px;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;}
#viewer-panel.show{display:flex;}
#cam-id-input{flex:1;padding:10px 12px;background:var(--s2);color:var(--gold);border:1px solid var(--border);border-radius:8px;font-family:var(--font-mono);font-size:1rem;letter-spacing:0.12em;outline:none;text-transform:uppercase;min-width:0;}
#cam-id-input:focus{border-color:var(--gold-dim);box-shadow:0 0 10px rgba(255,215,0,0.1);}
#cam-id-input::placeholder{color:rgba(255,215,0,0.2);letter-spacing:0.08em;}
#watch-btn{padding:0 18px;height:44px;font-family:var(--font-ui);font-size:0.88rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;background:rgba(255,215,0,0.1);color:var(--gold);border:1px solid var(--gold-dim);border-radius:8px;cursor:pointer;transition:all 0.2s;white-space:nowrap;flex-shrink:0;box-shadow:0 0 14px var(--gold-glow);}
#watch-btn:hover{background:rgba(255,215,0,0.2);}
#watch-btn:disabled{opacity:0.4;cursor:not-allowed;}

/* CAMERA SECTION */
#cam-section{flex:1;min-height:0;display:flex;flex-direction:column;padding:10px 14px 6px;}
#cam-wrapper{flex:1;min-height:0;position:relative;border-radius:20px;overflow:hidden;border:1px solid var(--border);background:var(--s1);box-shadow:inset 0 0 35px rgba(255,215,0,0.05),0 0 40px rgba(0,0,0,0.7);}
#cam-wrapper::before,#cam-wrapper::after{content:'';position:absolute;width:18px;height:18px;border-color:rgba(255,215,0,0.5);border-style:solid;z-index:6;pointer-events:none;}
#cam-wrapper::before{top:10px;left:10px;border-width:2px 0 0 2px;border-radius:3px 0 0 0;}
#cam-wrapper::after{bottom:10px;right:10px;border-width:0 2px 2px 0;border-radius:0 0 3px 0;}
#camera-feed{width:100%;height:100%;object-fit:cover;display:block;border-radius:20px;}
#motion-canvas{display:none;position:absolute;inset:0;}

/* PLACEHOLDER */
#cam-placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;border-radius:20px;background:var(--s1);}
#cam-placeholder svg{opacity:0.15;width:56px;height:56px;}
#cam-placeholder p{font-family:var(--font-mono);font-size:0.72rem;letter-spacing:0.15em;text-transform:uppercase;color:rgba(255,215,0,0.3);text-align:center;padding:0 24px;line-height:1.7;}

/* CAMERA ID ‚Äî bold center top of video */
#cam-id-overlay{
  position:absolute;top:16px;left:50%;transform:translateX(-50%);
  z-index:20;display:none;
  font-family:'Share Tech Mono',monospace;font-size:1.15rem;font-weight:700;
  letter-spacing:0.25em;text-transform:uppercase;color:#FFD700;
  background:rgba(0,0,0,0.82);backdrop-filter:blur(10px);
  padding:8px 22px;border-radius:30px;
  border:1.5px solid rgba(255,215,0,0.55);
  box-shadow:0 0 24px rgba(255,215,0,0.3);
  text-shadow:0 0 14px rgba(255,215,0,0.8);
  white-space:nowrap;pointer-events:none;
}

/* LIVE badge */
#live-badge{position:absolute;bottom:14px;left:14px;display:none;align-items:center;gap:6px;background:rgba(0,0,0,0.75);backdrop-filter:blur(6px);border:1px solid rgba(255,59,59,0.5);border-radius:8px;padding:4px 10px;font-family:var(--font-mono);font-size:0.68rem;letter-spacing:0.14em;color:#fff;z-index:6;}
#live-badge .ldot{width:7px;height:7px;border-radius:50%;background:var(--red);box-shadow:0 0 7px var(--red-glow);animation:blink 1.2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.15}}

/* Stats */
#cam-stats{position:absolute;bottom:14px;right:14px;display:flex;flex-direction:column;align-items:flex-end;gap:4px;z-index:6;pointer-events:none;}
.stat-chip{display:flex;align-items:center;background:rgba(0,0,0,0.72);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-family:var(--font-mono);font-size:0.62rem;letter-spacing:0.09em;color:rgba(255,215,0,0.5);}
.stat-chip.hot{border-color:rgba(255,59,59,0.5);color:var(--red);background:rgba(255,59,59,0.12);}

/* Alert flash */
#alert-flash{position:absolute;inset:0;border-radius:20px;pointer-events:none;z-index:5;opacity:0;transition:opacity 0.1s;}
#alert-flash.motion{background:radial-gradient(ellipse at center,rgba(255,215,0,0.1) 0%,transparent 70%);border:2px solid rgba(255,215,0,0.35);border-radius:20px;}
#alert-flash.sound{background:radial-gradient(ellipse at center,rgba(255,59,59,0.1) 0%,transparent 70%);border:2px solid rgba(255,59,59,0.35);border-radius:20px;}

/* CONTROLS */
#ctrl-bar{display:flex;flex-wrap:wrap;align-items:center;gap:8px;padding:8px 0 4px;flex-shrink:0;}
.ctrl-btn{padding:0 16px;height:44px;font-family:var(--font-ui);font-size:0.88rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;background:var(--s2);color:var(--gold);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;white-space:nowrap;flex-shrink:0;}
.ctrl-btn:hover{background:var(--s3);box-shadow:0 0 16px var(--gold-glow);border-color:rgba(255,215,0,0.35);}
.ctrl-btn:active{transform:scale(0.97);}
.ctrl-btn.primary{background:rgba(255,215,0,0.1);border-color:var(--gold-dim);box-shadow:0 0 14px var(--gold-glow);}
.ctrl-btn.danger{border-color:rgba(255,59,59,0.4);color:var(--red);}
.ctrl-btn:disabled{opacity:0.35;cursor:not-allowed;transform:none;}
#sens-group{display:flex;flex-direction:column;gap:3px;flex:1;min-width:110px;}
#sens-label{font-family:var(--font-mono);font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;color:rgba(255,215,0,0.45);display:flex;justify-content:space-between;}
#sens-label span{color:var(--gold);}
#sensitivity{-webkit-appearance:none;appearance:none;width:100%;height:4px;border-radius:2px;background:linear-gradient(to right,var(--gold-dim) 50%,var(--s3) 50%);outline:none;cursor:pointer;}
#sensitivity::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--gold);border:2px solid var(--bg);box-shadow:0 0 8px var(--gold-glow);cursor:pointer;}
#sensitivity::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--gold);border:2px solid var(--bg);cursor:pointer;}
#alert-bar{width:100%;padding:7px 12px;background:var(--s2);border:1px solid var(--border);border-radius:8px;font-family:var(--font-mono);font-size:0.72rem;letter-spacing:0.09em;color:rgba(255,215,0,0.45);display:flex;align-items:center;gap:8px;transition:all 0.3s;}
#alert-bar .ab-dot{width:7px;height:7px;border-radius:50%;background:rgba(255,215,0,0.25);flex-shrink:0;transition:all 0.3s;}
#alert-bar.motion-alert{border-color:rgba(255,215,0,0.45);color:var(--gold);background:rgba(255,215,0,0.07);}
#alert-bar.motion-alert .ab-dot{background:var(--gold);box-shadow:0 0 8px var(--gold-glow);animation:pdot 0.8s infinite;}
#alert-bar.sound-alert{border-color:rgba(255,59,59,0.5);color:var(--red);background:rgba(255,59,59,0.07);}
#alert-bar.sound-alert .ab-dot{background:var(--red);box-shadow:0 0 8px var(--red-glow);animation:pdot 0.8s infinite;}

/* TOASTS */
#toast-stack{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:1000;display:flex;flex-direction:column-reverse;gap:6px;pointer-events:none;width:calc(100% - 28px);max-width:420px;}
.toast{padding:10px 14px;border-radius:8px;font-family:var(--font-mono);font-size:0.75rem;letter-spacing:0.08em;background:rgba(14,14,14,0.97);border:1px solid var(--border);backdrop-filter:blur(10px);color:var(--gold);animation:tin 0.25s ease,tout 0.3s ease 2.7s forwards;box-shadow:0 4px 20px rgba(0,0,0,0.5);}
.toast.error{border-color:rgba(255,59,59,0.5);color:var(--red);}
.toast.success{border-color:rgba(57,255,20,0.4);color:var(--green);}
@keyframes tin{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes tout{from{opacity:1}to{opacity:0}}
@media(min-width:600px){#ctrl-bar{flex-wrap:nowrap;}#alert-bar{width:auto;flex:1;}}
</style>
</head>
<body>
<div id="app">

  <!-- TOP BAR -->
  <div id="top-bar">
    <img id="logo" src="https://i.ibb.co/gFMKLNWd/Chat-GPT-Image-Dec-31-2025-01-45-02-AM-Photoroom.png" alt="Yamassee">
    <div id="conn-status" class="offline">
      <div class="dot"></div>
      <span id="conn-text">Offline</span>
    </div>
  </div>

  <!-- TABS -->
  <div id="role-tabs">
    <button class="rtab active" id="tab-camera" onclick="switchRole('camera')">üì∑ Room Camera</button>
    <button class="rtab"        id="tab-viewer" onclick="switchRole('viewer')">üëÅ Viewer</button>
  </div>

  <!-- VIEWER: enter Camera ID -->
  <div id="viewer-panel">
    <input id="cam-id-input" type="text" placeholder="Enter Camera ID" maxlength="20" oninput="this.value=this.value.toUpperCase()">
    <button id="watch-btn" onclick="startWatching()">Watch</button>
  </div>

  <!-- CAMERA + CONTROLS -->
  <div id="cam-section">
    <div id="cam-wrapper">
      <video id="camera-feed" autoplay muted playsinline></video>
      <canvas id="motion-canvas"></canvas>

      <!-- Placeholder -->
      <div id="cam-placeholder">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="4" y="14" width="56" height="36" rx="6" stroke="#FFD700" stroke-width="2.5"/>
          <circle cx="32" cy="32" r="9" stroke="#FFD700" stroke-width="2.5"/>
          <rect x="22" y="10" width="20" height="6" rx="3" stroke="#FFD700" stroke-width="2"/>
          <circle cx="52" cy="22" r="3" fill="#FFD700" opacity="0.6"/>
        </svg>
        <p id="placeholder-msg">Tap Start Camera to begin</p>
      </div>

      <!-- Camera ID shown on video -->
      <div id="cam-id-overlay"></div>

      <!-- LIVE badge -->
      <div id="live-badge"><div class="ldot"></div>LIVE</div>

      <!-- Stats -->
      <div id="cam-stats">
        <div class="stat-chip" id="stat-motion">MOTION: ‚Äî</div>
        <div class="stat-chip" id="stat-sound">SOUND: ‚Äî</div>
      </div>

      <!-- Alert flash -->
      <div id="alert-flash"></div>
    </div>

    <!-- CONTROLS -->
    <div id="ctrl-bar">
      <button class="ctrl-btn primary" id="start-btn" onclick="startCamera()">Start Camera</button>
      <button class="ctrl-btn danger"  id="stop-btn"  onclick="stopCamera()" disabled>Stop</button>
      <div id="sens-group">
        <div id="sens-label">Sensitivity <span id="sens-val">5</span></div>
        <input type="range" id="sensitivity" min="1" max="10" value="5" oninput="updateSens(this.value)">
      </div>
      <div id="alert-bar">
        <div class="ab-dot"></div>
        <span id="alert-text">No Alerts</span>
      </div>
    </div>
  </div>
</div>
<div id="toast-stack"></div>

<script>
/* ============================================================
  YAMASSEE SMART MONITOR
  Uses PeerJS (free hosted signaling) ‚Äî works on GitHub Pages,
  no server needed, works across any device/network.

  CAMERA SIDE:
    - Opens camera, gets a short Peer ID
    - Displays that ID on the video feed
    - Waits for viewers to call in

  VIEWER SIDE:
    - Enters the Camera ID from the camera screen
    - Connects via WebRTC through PeerJS
    - Motion + sound detection runs HERE on the viewer

  HOW TO USE:
    1. Camera device: open app ‚Üí Start Camera ‚Üí note the ID on screen
    2. Viewer device: open app ‚Üí Viewer tab ‚Üí type that ID ‚Üí Watch
============================================================ */

// ‚îÄ‚îÄ SHORT ID GENERATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function shortId() {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let id = "YAM-";
  for (let i=0; i<4; i++) id += chars[Math.floor(Math.random()*chars.length)];
  return id;
}

// ‚îÄ‚îÄ DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const $ = id => document.getElementById(id);
const video       = $('camera-feed');
const canvas      = $('motion-canvas');
const placeholder = $('cam-placeholder');
const liveBadge   = $('live-badge');
const idOverlay   = $('cam-id-overlay');
const alertBar    = $('alert-bar');
const alertText   = $('alert-text');
const alertFlash  = $('alert-flash');
const connStatus  = $('conn-status');
const connText    = $('conn-text');
const statMotion  = $('stat-motion');
const statSound   = $('stat-sound');
const startBtn    = $('start-btn');
const stopBtn     = $('stop-btn');

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let role        = 'camera';
let peer        = null;   // PeerJS instance
let localStream = null;
let sensitivity = 5;
let motionCtx   = null;
let prevFrame   = null;
let frameLoop   = null;
let audioCtx    = null;
let analyser    = null;
let lastMotion  = 0;
let lastSound   = 0;
let activeCall  = null;   // current PeerJS call

// ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, type='') {
  const t = document.createElement('div');
  t.className = 'toast '+type;
  t.textContent = msg;
  $('toast-stack').prepend(t);
  setTimeout(()=>t.remove(), 3200);
}
function setConn(cls, txt) { connStatus.className=cls; connText.textContent=txt; }
function setAlert(type, msg) {
  alertBar.className = type==='clear' ? '' : type+'-alert';
  alertText.textContent = msg;
  if (type!=='clear') {
    alertFlash.className = type;
    alertFlash.style.opacity = '1';
    setTimeout(()=>{ alertFlash.style.opacity='0'; alertFlash.className=''; }, 700);
    setTimeout(()=>setAlert('clear','No Alerts'), 4000);
  }
}
function updateSens(v) {
  sensitivity = parseInt(v);
  $('sens-val').textContent = v;
  $('sensitivity').style.background =
    `linear-gradient(to right,var(--gold-dim) 0%,var(--gold-dim) ${v*10}%,var(--s3) ${v*10}%,var(--s3) 100%)`;
}
updateSens(5);

// ‚îÄ‚îÄ ROLE SWITCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchRole(r) {
  role = r;
  $('tab-camera').classList.toggle('active', r==='camera');
  $('tab-viewer').classList.toggle('active', r==='viewer');
  $('viewer-panel').classList.toggle('show', r==='viewer');
  startBtn.style.display = r==='camera' ? '' : 'none';
  stopBtn.style.display  = r==='camera' ? '' : 'none';
  $('sens-group').style.display = r==='camera' ? '' : 'none';
  if (r==='viewer') {
    stopCamera();
    $('placeholder-msg').textContent = 'Enter the Camera ID above and tap Watch';
    video.muted = false;
  } else {
    stopDetection();
    $('placeholder-msg').textContent = 'Tap Start Camera to begin';
    video.muted = true;
  }
}

// ‚îÄ‚îÄ START CAMERA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startCamera() {
  startBtn.disabled = true;
  setConn('connecting','Starting...');
  $('placeholder-msg').textContent = 'Requesting camera access...';

  // Get camera + mic
  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  } catch(e1) {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video:true });
      toast('Mic unavailable ‚Äî video only','');
    } catch(e2) {
      startBtn.disabled = false;
      setConn('offline','Offline');
      $('placeholder-msg').textContent = 'Camera denied ‚Äî check browser permissions';
      toast('Camera access denied','error');
      return;
    }
  }

  localStream = stream;
  video.muted  = true;  // prevent mic feedback on camera device
  video.srcObject = stream;

  // Show video immediately
  placeholder.style.display = 'none';
  liveBadge.style.display   = 'flex';
  stopBtn.disabled  = false;
  startBtn.textContent = 'Restart';
  startBtn.disabled = false;

  // Create PeerJS peer ‚Äî gets a free unique ID from PeerJS servers
  setConn('connecting','Getting ID...');
  $('placeholder-msg').textContent = '';

  if (peer) { peer.destroy(); peer = null; }

  const myId = shortId();
  peer = new Peer(myId, { debug: 0 });

  peer.on('open', (id) => {
    // Show the ID on the video feed ‚Äî this is what viewer types in
    idOverlay.textContent = id;
    idOverlay.style.display = 'block';
    setConn('live', 'Broadcasting');
    toast('Camera live! Share ID: '+id, 'success');
  });

  peer.on('error', (err) => {
    toast('Connection error: '+err.type, 'error');
    console.error('PeerJS error:', err);
  });

  // When a viewer calls in, answer with our stream
  peer.on('call', (call) => {
    activeCall = call;
    call.answer(localStream);
    toast('üëÅ Viewer connected', 'success');
    call.on('close', ()=>toast('Viewer disconnected',''));
    call.on('error', (e)=>console.warn('Call error:',e));
  });
}

// ‚îÄ‚îÄ STOP CAMERA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function stopCamera() {
  if (activeCall) { activeCall.close(); activeCall=null; }
  if (peer)       { peer.destroy(); peer=null; }
  if (localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
  video.srcObject = null;
  video.muted = true;
  placeholder.style.display = '';
  liveBadge.style.display   = 'none';
  idOverlay.style.display   = 'none';
  idOverlay.textContent     = '';
  startBtn.textContent = 'Start Camera';
  startBtn.disabled = false;
  stopBtn.disabled  = true;
  setConn('offline','Offline');
  setAlert('clear','No Alerts');
  stopDetection();
  statMotion.textContent = 'MOTION: ‚Äî';
  statSound.textContent  = 'SOUND: ‚Äî';
}

// ‚îÄ‚îÄ VIEWER: CONNECT TO CAMERA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startWatching() {
  const camId = $('cam-id-input').value.trim();
  if (!camId) { toast('Enter a Camera ID','error'); return; }

  $('watch-btn').disabled = true;
  setConn('connecting','Connecting...');
  $('placeholder-msg').textContent = 'Connecting to camera...';
  placeholder.style.display = '';

  if (peer) { peer.destroy(); peer=null; }

  // Create a viewer peer
  peer = new Peer({ debug: 0 });

  peer.on('error', (err)=>{
    toast('Could not connect: '+err.type,'error');
    $('watch-btn').disabled = false;
    setConn('offline','Offline');
    $('placeholder-msg').textContent = 'Connection failed ‚Äî check the Camera ID';
  });

  peer.on('open', () => {
    // Call the camera peer ID
    const call = peer.call(camId, new MediaStream()); // empty stream ‚Äî viewer receives only
    activeCall = call;

    if (!call) {
      toast('Could not reach camera ‚Äî is it online?','error');
      $('watch-btn').disabled = false;
      setConn('offline','Offline');
      return;
    }

    // Receive the camera stream
    call.on('stream', (remoteStream) => {
      video.muted = false;
      video.srcObject = remoteStream;
      placeholder.style.display = 'none';
      liveBadge.style.display   = 'flex';
      setConn('watching','Watching');
      $('watch-btn').disabled = false;
      toast('‚úì Live feed connected','success');

      // ‚îÄ‚îÄ DETECTION RUNS ON VIEWER SIDE ‚îÄ‚îÄ
      startDetection(remoteStream);
    });

    call.on('close', ()=>{
      setConn('offline','Disconnected');
      video.srcObject = null;
      liveBadge.style.display = 'none';
      placeholder.style.display = '';
      $('placeholder-msg').textContent = 'Camera disconnected';
      $('watch-btn').disabled = false;
      stopDetection();
      toast('Camera feed ended','error');
    });

    call.on('error', (e)=>{
      toast('Stream error','error');
      $('watch-btn').disabled = false;
      console.error(e);
    });

    // Timeout if no stream arrives in 10s
    setTimeout(()=>{
      if (!video.srcObject) {
        toast('No response ‚Äî check Camera ID','error');
        $('watch-btn').disabled = false;
        setConn('offline','Offline');
        $('placeholder-msg').textContent = 'No camera found with that ID';
        call.close();
      }
    }, 10000);
  });
}

// ‚îÄ‚îÄ DETECTION (runs on VIEWER) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startDetection(stream) {
  stopDetection();

  // MOTION ‚Äî canvas frame-diff on the video element
  canvas.width  = 160;
  canvas.height = 120;
  motionCtx = canvas.getContext('2d', { willReadFrequently:true });
  prevFrame = null;
  motionLoop();

  // SOUND ‚Äî analyze incoming audio track
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaStreamSource(stream);
    analyser  = audioCtx.createAnalyser();
    analyser.fftSize = 512;
    src.connect(analyser);
    soundLoop();
  } catch(e) {
    console.warn('Audio detection unavailable:', e);
  }
}

function stopDetection() {
  if (frameLoop) { cancelAnimationFrame(frameLoop); frameLoop=null; }
  if (audioCtx)  { try{audioCtx.close();}catch(e){} audioCtx=null; analyser=null; }
  prevFrame = null;
}

function motionLoop() {
  if (!video.srcObject) return;
  frameLoop = requestAnimationFrame(() => setTimeout(motionLoop, 120));
  if (video.readyState < 2) return;

  motionCtx.drawImage(video, 0, 0, 160, 120);
  const cur = motionCtx.getImageData(0, 0, 160, 120);

  if (prevFrame) {
    const d1 = prevFrame.data, d2 = cur.data;
    let changed = 0;
    const total = d1.length / 4;
    const thr   = 28 * (1 - (sensitivity-1)/12);

    for (let i=0; i<d1.length; i+=4) {
      if ((Math.abs(d1[i]-d2[i]) + Math.abs(d1[i+1]-d2[i+1]) + Math.abs(d1[i+2]-d2[i+2])) / 3 > thr)
        changed++;
    }

    const ratio = changed / total;
    const lvl   = Math.min(100, Math.round(ratio * 4500));
    statMotion.textContent = 'MOTION: '+lvl+'%';
    statMotion.classList.toggle('hot', lvl > 25);

    const triggerPct = 0.012 * (1 - (sensitivity-1)/14);
    const now = Date.now();
    if (ratio > triggerPct && now - lastMotion > 2500) {
      lastMotion = now;
      fireAlert('motion', '‚ö° Motion Detected');
    }
  }
  prevFrame = cur;
}

function soundLoop() {
  if (!audioCtx) return;
  requestAnimationFrame(soundLoop);

  const data = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(data);
  let sum = 0;
  for (let i=0; i<data.length; i++) sum += data[i];
  const avg = sum / data.length / 255;
  const lvl = Math.min(100, Math.round(avg * 500));

  statSound.textContent = 'SOUND: '+lvl+'%';
  statSound.classList.toggle('hot', lvl > 30);

  const thr = 0.10 * (1 - (sensitivity-1)/13);
  const now = Date.now();
  if (avg > thr && now - lastSound > 2000) {
    lastSound = now;
    fireAlert('sound', 'üîä Sound Detected');
  }
}

function fireAlert(type, msg) {
  setAlert(type, msg);
  toast('üîî '+msg, type==='sound' ? 'error' : '');
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
switchRole('camera');
</script>
</body>
</html>
